<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bon d'Intervention - CEP (Admin)</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #f6ad55;
            --accent-dark: #dd6b20;
            --bg: #f7fafc;
            --card: #ffffff;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
            --success: #48bb78;
            --danger: #fc8181;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 30px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .logo-section h1 { font-size: 1.5rem; font-weight: 700; }
        .logo-section p { font-size: 0.9rem; opacity: 0.9; margin-top: 4px; }
        .bon-number { background: rgba(255,255,255,0.15); padding: 12px 20px; border-radius: 10px; text-align: right; }
        .bon-number span { font-family: 'Space Mono', monospace; font-size: 1.3rem; font-weight: 700; }
        .bon-number p { font-size: 0.8rem; opacity: 0.8; }
        .form-body { background: var(--card); padding: 30px; border: 1px solid var(--border); border-top: none; }
        .section { margin-bottom: 30px; }
        .section-title { font-size: 1.1rem; font-weight: 600; color: var(--primary); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--accent); display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: ''; width: 4px; height: 20px; background: var(--accent); border-radius: 2px; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .input-group label { font-size: 0.85rem; font-weight: 500; color: var(--text-light); margin-bottom: 6px; }
        .input-group input, .input-group textarea, .input-group select { padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 1rem; transition: all 0.2s ease; background: white; }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1); }
        
        /* S√©lecteur de mat√©riel */
        .material-selector { background: #f0f7ff; border: 2px solid var(--primary); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .material-selector label { font-weight: 600; color: var(--primary); margin-bottom: 10px; display: block; }
        .material-selector-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .material-selector select { flex: 1; min-width: 200px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; background: white; }
        .material-selector input[type="number"] { width: 80px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; text-align: center; font-family: 'Space Mono', monospace; }
        .material-selector .btn-add { padding: 12px 20px; background: var(--success); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .material-selector .btn-add:hover { background: #38a169; transform: scale(1.05); }

        .category-section { margin-bottom: 20px; }
        .category-header { background: var(--primary); color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .category-header:hover { background: var(--primary-light); }
        .category-header .toggle-icon { transition: transform 0.3s; }
        .category-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        .category-content { border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px; overflow: hidden; }
        .category-content.hidden { display: none; }
        /* Version admin : affichage complet avec prix et totaux */
        .product-row { display: grid; grid-template-columns: 40px 1fr 90px 80px 90px; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .product-row:last-child { border-bottom: none; }
        .product-row:hover { background: #f8fafc; }
        .product-row.selected { background: #ebf8ff; }
        .product-row input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        .product-name { font-size: 0.85rem; }
        .product-ref { font-size: 0.7rem; color: var(--text-light); font-family: 'Space Mono', monospace; }
        .product-price { font-weight: 600; color: var(--primary); text-align: center; font-size: 0.85rem; }
        .product-qty input { width: 55px; padding: 5px; text-align: center; border: 2px solid var(--border); border-radius: 6px; font-family: 'Space Mono', monospace; }
        .product-total { font-weight: 700; color: var(--accent-dark); text-align: right; font-family: 'Space Mono', monospace; font-size: 0.9rem; }

        .service-row { display: grid; grid-template-columns: 1fr 120px 120px 120px; align-items: center; padding: 15px; background: #fffaf0; border: 2px solid var(--accent); border-radius: 10px; margin-bottom: 10px; gap: 10px; }
        /* Ajuster la grille pour Main d'≈ìuvre (sans demi-heures ni tarif unitaire) */
        .service-row:has(#moDemiHeures[style*="display: none"]) {
            grid-template-columns: 1fr 150px 120px;
        }
        /* Ajuster la grille pour D√©placement (nombre + total uniquement) */
        .service-row:has(#deplNombre) {
            grid-template-columns: 1fr 150px 120px;
        }
        .service-row label { font-weight: 600; }
        .service-row input { padding: 8px; border: 2px solid var(--border); border-radius: 6px; font-family: 'Space Mono', monospace; text-align: center; }

        .totals-section { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 25px; border-radius: 12px; margin-top: 20px; }
        .total-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 1rem; }
        .total-row.grand-total { font-size: 1.4rem; font-weight: 700; border-top: 2px solid rgba(255,255,255,0.3); padding-top: 15px; margin-top: 10px; }
        .total-row span:last-child { font-family: 'Space Mono', monospace; }

        .signature-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px; }
        .signature-box { border: 2px dashed var(--border); border-radius: 12px; padding: 20px; text-align: center; }
        .signature-box h4 { font-size: 0.9rem; color: var(--text-light); margin-bottom: 15px; }
        .signature-canvas { width: 100%; height: 120px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: crosshair; touch-action: none; }
        .signature-actions { margin-top: 10px; }
        .btn-clear { padding: 6px 12px; font-size: 0.8rem; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; }

        .actions { display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap; }
        .btn { flex: 1; min-width: 200px; padding: 16px 30px; font-size: 1rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%); color: white; box-shadow: 0 4px 15px rgba(246, 173, 85, 0.4); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(246, 173, 85, 0.5); }
        .btn-secondary { background: var(--card); color: var(--primary); border: 2px solid var(--primary); }
        .btn-secondary:hover { background: var(--primary); color: white; }
        .btn-email { padding: 8px 12px; font-size: 0.8rem; font-weight: 500; border-radius: 8px; border: 1px solid var(--primary); background: var(--card); color: var(--primary); cursor: pointer; align-self: flex-start; }
        .btn-email:hover { background: var(--primary); color: #fff; }
        .photos-preview-admin { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .photos-preview-admin img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; }
        .photo-thumb-admin { position: relative; display: inline-block; }
        .photo-remove-admin { position: absolute; top: -6px; right: -6px; background: rgba(0,0,0,0.7); color: #fff; border: none; border-radius: 999px; width: 18px; height: 18px; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .photo-lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .photo-lightbox.show { display: flex; }
        .photo-lightbox img { max-width: 90vw; max-height: 90vh; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .photo-lightbox-close { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.7); color: #fff; border: none; border-radius: 999px; width: 32px; height: 32px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .material-search { padding: 8px 10px; border: 2px solid var(--border); border-radius: 8px; font-size: 0.9rem; min-width: 180px; }

        .footer { background: var(--primary); color: white; padding: 20px 30px; border-radius: 0 0 16px 16px; text-align: center; font-size: 0.85rem; }

        @media (max-width: 768px) {
            .product-row { grid-template-columns: 30px 1fr 60px 70px; }
            .service-row { grid-template-columns: 1fr 1fr; }
            .signature-section { grid-template-columns: 1fr; }
            .header { flex-direction: column; text-align: center; }
            .bon-number { text-align: center; }
            .material-selector-row { flex-direction: column; }
            .material-selector select, .material-selector input[type="number"] { width: 100%; }
        }
        @media print {
            body { padding: 0; background: white; }
            .btn, .actions, .btn-clear, .material-selector { display: none !important; }
            .header, .footer, .totals-section { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
    <!-- EmailJS pour l'envoi automatique d'emails -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function() {
            emailjs.init("GXDaMfa8u-ZzmkvNn");
        })();
    </script>
    <!-- jsPDF pour la g√©n√©ration de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- QR Code pour g√©n√©rer les QR codes de paiement -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- SheetJS pour lire et √©crire les fichiers Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-section">
                <h1>‚ö° Compagnie d'√âlectricit√© Parisienne</h1>
                <p>Bon d'Intervention (Admin)</p>
            </div>
            <div class="bon-number">
                <span id="bonNumber">CEP-2024-0001</span>
                <p id="currentDate"></p>
            </div>
        </div>

        <div class="form-body">
            <div class="section">
                <h3 class="section-title">Informations Client</h3>
                <div class="input-grid">
                    <div class="input-group"><label>Nom / Soci√©t√©</label><input type="text" id="clientName" placeholder="Nom du client"></div>
                    <div class="input-group"><label>T√©l√©phone</label><input type="tel" id="clientPhone" placeholder="06 12 34 56 78"></div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="clientEmail" placeholder="email@exemple.fr">
                        <button type="button" class="btn-email" onclick="envoyerClient()">Envoyer au client</button>
                    </div>
                    <div class="input-group"><label>Adresse</label><input type="text" id="clientAddress" placeholder="Adresse compl√®te"></div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">D√©tails de l'Intervention</h3>
                <div class="input-grid">
                    <div class="input-group"><label>Date</label><input type="date" id="interventionDate"></div>
                    <div class="input-group">
                        <label>Technicien</label>
                        <select id="technicien">
                            <option value="">-- S√©lectionner un technicien --</option>
                            <option value="Christophe Tavares">Christophe Tavares</option>
                            <option value="Ricardo Dassilva">Ricardo Dassilva</option>
                            <option value="Mathieu Rodriguez">Mathieu Rodriguez</option>
                        </select>
                    </div>
                    <div class="input-group" style="display: flex; flex-direction: column; gap: 0;">
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label>üïê Heure d'arriv√©e</label>
                            <input type="time" id="heureArrivee" onchange="calculerMainOeuvre()">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 15px;">
                            <label>üïê Heure de d√©part</label>
                            <input type="time" id="heureDepart" onchange="calculerMainOeuvre()">
                        </div>
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label>Description</label>
                        <textarea id="description" rows="2" placeholder="Travaux effectu√©s..."></textarea>
                        <div style="margin-top:6px;">
                            <strong style="font-size:0.8rem; color:var(--text-light);">Photos de l'intervention</strong>
                            <div id="photosAdmin" class="photos-preview-admin">
                                <p style="color:var(--text-light); margin-top:4px;">Aucune photo pour ce bon.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">Produits Utilis√©s</h3>
                
                <!-- S√©lecteur rapide de mat√©riel -->
                <div class="material-selector">
                    <label>‚ö° Ajout rapide de mat√©riel</label>
                    <div class="material-selector-row">
                        <input type="text" id="materialSearchAdmin" class="material-search" placeholder="Rechercher un produit..." oninput="filterMaterialsAdmin()">
                        <select id="materialSelect">
                            <option value="">-- Choisir un produit --</option>
                            <optgroup label="üîå C√¢bles">
                                <option value="0" data-price="0.6">3G0,75 - 0.60‚Ç¨/m</option>
                                <option value="1" data-price="1.3">3G1,5 - 1.30‚Ç¨/m</option>
                                <option value="2" data-price="2">3G2,5 - 2.00‚Ç¨/m</option>
                                <option value="3" data-price="2.1">5G1,5 - 2.10‚Ç¨/m</option>
                                <option value="4" data-price="3.2">5G2,5 - 3.20‚Ç¨/m</option>
                                <option value="5" data-price="4.5">5G6 - 4.50‚Ç¨/m</option>
                                <option value="6" data-price="14">5G10 - 14‚Ç¨/m</option>
                                <option value="7" data-price="22">5G16 - 22‚Ç¨/m</option>
                                <option value="8" data-price="50">4X35 - 50‚Ç¨/m</option>
                                <option value="9" data-price="3">3G1,5 Pyrolion - 3‚Ç¨/m</option>
                                <option value="10" data-price="4.35">3G2,5 Pyrolion - 4.35‚Ç¨/m</option>
                                <option value="11" data-price="6.5">5G2,5 Pyrolion - 6.50‚Ç¨/m</option>
                                <option value="12" data-price="1.8">C√¢ble Info Cat.6 - 1.80‚Ç¨/m</option>
                                <option value="13" data-price="3.4">C√¢ble Sono 2X1,5 - 3.40‚Ç¨/m</option>
                                <option value="14" data-price="1">Gaine Grise √ò20 - 1‚Ç¨/m</option>
                            </optgroup>
                            <optgroup label="üîß Disjoncteurs Mono">
                                <option value="15" data-price="37">2A Mono 6kA - 37‚Ç¨</option>
                                <option value="16" data-price="39">4A Mono 6kA - 39‚Ç¨</option>
                                <option value="17" data-price="34">10A Mono 6kA - 34‚Ç¨</option>
                                <option value="18" data-price="34">16A Mono 6kA - 34‚Ç¨</option>
                                <option value="19" data-price="34">20A Mono 6kA - 34‚Ç¨</option>
                                <option value="20" data-price="37">32A Mono 6kA - 37‚Ç¨</option>
                            </optgroup>
                            <optgroup label="üîß Disjoncteurs T√©tra">
                                <option value="21" data-price="114">10A T√©tra 6kA - 114‚Ç¨</option>
                                <option value="22" data-price="114">16A T√©tra 6kA - 114‚Ç¨</option>
                                <option value="23" data-price="114">20A T√©tra 6kA - 114‚Ç¨</option>
                                <option value="24" data-price="130">32A T√©tra 6kA - 130‚Ç¨</option>
                                <option value="25" data-price="158">40A T√©tra 6kA - 158‚Ç¨</option>
                                <option value="26" data-price="275">63A T√©tra 10kA - 275‚Ç¨</option>
                            </optgroup>
                            <optgroup label="üîå Appareillages Plexo">
                                <option value="27" data-price="15">Inter. Plexo Saillie - 15‚Ç¨</option>
                                <option value="28" data-price="22">Prise Plexo Simple - 22‚Ç¨</option>
                                <option value="29" data-price="42">Prise Plexo Double - 42‚Ç¨</option>
                                <option value="30" data-price="86">Prise Plexo Triple - 86‚Ç¨</option>
                                <option value="31" data-price="72">Prise T√©tra 20A - 72‚Ç¨</option>
                                <option value="32" data-price="25">Fiche T√©tra 20A - 25‚Ç¨</option>
                                <option value="33" data-price="8">Bo√Æte Plexo √ò60 - 8‚Ç¨</option>
                                <option value="34" data-price="12">Bo√Æte Plexo √ò80 - 12‚Ç¨</option>
                                <option value="35" data-price="27">Bo√Æte Plexo √ò100 - 27‚Ç¨</option>
                                <option value="36" data-price="30">Prise Encastr√© Simple - 30‚Ç¨</option>
                                <option value="37" data-price="59">Prise Encastr√© Double - 59‚Ç¨</option>
                                <option value="38" data-price="90">Prise Encastr√© Triple - 90‚Ç¨</option>
                                <option value="39" data-price="67">Prise T√©tra Encastr√© - 67‚Ç¨</option>
                            </optgroup>
                            <optgroup label="üö® BAES & Peignes">
                                <option value="40" data-price="130">BAES Legrand - 130‚Ç¨</option>
                                <option value="41" data-price="120">BAES URA ONE - 120‚Ç¨</option>
                                <option value="42" data-price="290">T√©l√©commande BAES - 290‚Ç¨</option>
                                <option value="43" data-price="42">Peigne Mono DT40 - 42‚Ç¨</option>
                                <option value="44" data-price="76">Peigne T√©tra IDT40 - 76‚Ç¨</option>
                                <option value="45" data-price="28">Peigne T√©tra IC60 - 28‚Ç¨</option>
                            </optgroup>
                            <optgroup label="üí° √âclairage & LED">
                                <option value="46" data-price="8">Ampoule E27 2W - 8‚Ç¨</option>
                                <option value="47" data-price="9">Ampoule E27 4W Dim - 9‚Ç¨</option>
                                <option value="48" data-price="125">Guirlande 12m - 125‚Ç¨</option>
                                <option value="49" data-price="9">Ampoule GU10 7W - 9‚Ç¨</option>
                                <option value="50" data-price="1.1">Douille GU10 - 1.10‚Ç¨</option>
                                <option value="51" data-price="28">Ruban LED COB480 - 28‚Ç¨/m</option>
                                <option value="52" data-price="7.6">Profil√© Alu - 7.60‚Ç¨/m</option>
                                <option value="53" data-price="7.2">Capot Blanc - 7.20‚Ç¨/m</option>
                                <option value="54" data-price="105">Transfo 24V 100W - 105‚Ç¨</option>
                            </optgroup>
                            <optgroup label="üéõÔ∏è Variateurs">
                                <option value="55" data-price="390">RVLED 250W - 390‚Ç¨</option>
                                <option value="56" data-price="430">RVLED 500W - 430‚Ç¨</option>
                                <option value="57" data-price="490">RVLED 1000W - 490‚Ç¨</option>
                                <option value="58" data-price="65">Potentiom√®tre - 65‚Ç¨</option>
                                <option value="59" data-price="8.5">Support Potentiom√®tre - 8.50‚Ç¨</option>
                            </optgroup>
                        </select>
                        <input type="number" id="materialQty" value="1" min="1" placeholder="Qt√©">
                        <button class="btn-add" onclick="addMaterial()">+ Ajouter</button>
                    </div>
                </div>
                
                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üîå C√¢bles</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="0"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">3G0,75</div></div><div class="product-price">0.60‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="0.6" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="1"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">3G1,5</div></div><div class="product-price">1.30‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="1.3" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="2"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">3G2,5</div></div><div class="product-price">2.00‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="2" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="3"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">5G1,5</div></div><div class="product-price">2.10‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="2.1" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="4"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">5G2,5</div></div><div class="product-price">3.20‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="3.2" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="5"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">5G6</div></div><div class="product-price">4.50‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="4.5" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="6"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">5G10</div></div><div class="product-price">14‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="14" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="7"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">5G16</div></div><div class="product-price">22‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="22" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="8"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">4X35</div></div><div class="product-price">50‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="50" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="9"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">3G1,5 Pyrolion</div></div><div class="product-price">3‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="3" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="10"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">3G2,5 Pyrolion</div></div><div class="product-price">4.35‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="4.35" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="11"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">5G2,5 Pyrolion</div></div><div class="product-price">6.50‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="6.5" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="12"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">C√¢ble Info Cat.6</div></div><div class="product-price">1.80‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="1.8" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="13"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">C√¢ble Sono 2X1,5</div></div><div class="product-price">3.40‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="3.4" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="14"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Gaine Grise √ò20</div></div><div class="product-price">1‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="1" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üîß Disjoncteurs Mono</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="15"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">2A Mono 6kA</div><div class="product-ref">A9P22602</div></div><div class="product-price">37‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="37" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="16"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">4A Mono 6kA</div><div class="product-ref">A9P22604</div></div><div class="product-price">39‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="39" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="17"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">10A Mono 6kA</div><div class="product-ref">A9P22610</div></div><div class="product-price">34‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="34" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="18"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">16A Mono 6kA</div><div class="product-ref">A9P22616</div></div><div class="product-price">34‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="34" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="19"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">20A Mono 6kA</div><div class="product-ref">A9P22620</div></div><div class="product-price">34‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="34" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="20"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">32A Mono 6kA</div><div class="product-ref">A9P22632</div></div><div class="product-price">37‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="37" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üîß Disjoncteurs T√©tra</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="21"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">10A T√©tra 6kA</div><div class="product-ref">A9P22710</div></div><div class="product-price">114‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="114" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="22"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">16A T√©tra 6kA</div><div class="product-ref">A9P22716</div></div><div class="product-price">114‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="114" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="23"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">20A T√©tra 6kA</div><div class="product-ref">A9P22720</div></div><div class="product-price">114‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="114" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="24"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">32A T√©tra 6kA</div><div class="product-ref">A9P22732</div></div><div class="product-price">130‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="130" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="25"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">40A T√©tra 6kA</div><div class="product-ref">A9P22740</div></div><div class="product-price">158‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="158" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="26"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">63A T√©tra 10kA</div><div class="product-ref">A9P24463</div></div><div class="product-price">275‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="275" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üîå Appareillages Plexo</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="27"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Inter. Plexo Saillie</div><div class="product-ref">069711L</div></div><div class="product-price">15‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="15" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="28"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise Plexo Simple</div><div class="product-ref">069731L</div></div><div class="product-price">22‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="22" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="29"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise Plexo Double</div><div class="product-ref">069768L</div></div><div class="product-price">42‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="42" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="30"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise Plexo Triple</div><div class="product-ref">069680L</div></div><div class="product-price">86‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="86" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="31"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise T√©tra 20A</div><div class="product-ref">091657</div></div><div class="product-price">72‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="72" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="32"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Fiche T√©tra 20A</div><div class="product-ref">055637</div></div><div class="product-price">25‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="25" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="33"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Bo√Æte Plexo √ò60</div><div class="product-ref">092003</div></div><div class="product-price">8‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="8" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="34"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Bo√Æte Plexo √ò80</div><div class="product-ref">092013</div></div><div class="product-price">12‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="12" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="35"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Bo√Æte Plexo √ò100</div><div class="product-ref">092020</div></div><div class="product-price">27‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="27" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="36"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise Encastr√© Simple</div><div class="product-ref">069831L</div></div><div class="product-price">30‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="30" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="37"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise Encastr√© Double</div><div class="product-ref">069562L</div></div><div class="product-price">59‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="59" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="38"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise Encastr√© Triple</div><div class="product-ref">080053</div></div><div class="product-price">90‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="90" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="39"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise T√©tra Encastr√©</div><div class="product-ref">080051</div></div><div class="product-price">67‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="67" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üö® BAES & Peignes</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="40"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">BAES Legrand</div><div class="product-ref">062525</div></div><div class="product-price">130‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="130" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="41"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">BAES URA ONE</div><div class="product-ref">111013V</div></div><div class="product-price">120‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="120" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="42"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">T√©l√©commande BAES</div><div class="product-ref">062520</div></div><div class="product-price">290‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="290" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="43"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Peigne Mono DT40</div><div class="product-ref">A9XPN624</div></div><div class="product-price">42‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="42" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="44"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Peigne T√©tra IDT40</div><div class="product-ref">A9XPP724</div></div><div class="product-price">76‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="76" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="45"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Peigne T√©tra IC60</div><div class="product-ref">R9PXH424</div></div><div class="product-price">28‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="28" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üí° √âclairage & LED</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="46"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Ampoule E27 2W</div><div class="product-ref">716630</div></div><div class="product-price">8‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="8" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="47"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Ampoule E27 4W Dim</div><div class="product-ref">165458</div></div><div class="product-price">9‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="9" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="48"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Guirlande 12m</div></div><div class="product-price">125‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="125" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="49"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Ampoule GU10 7W</div></div><div class="product-price">9‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="9" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="50"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Douille GU10</div></div><div class="product-price">1.10‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="1.1" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="51"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Ruban LED COB480</div></div><div class="product-price">28‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="28" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="52"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Profil√© Alu</div></div><div class="product-price">7.60‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="7.6" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="53"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Capot Blanc</div></div><div class="product-price">7.20‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="7.2" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="54"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Transfo 24V 100W</div></div><div class="product-price">105‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="105" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üéõÔ∏è Variateurs</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="55"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">RVLED 250W</div></div><div class="product-price">390‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="390" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="56"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">RVLED 500W</div></div><div class="product-price">430‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="430" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="57"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">RVLED 1000W</div></div><div class="product-price">490‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="490" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="58"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Potentiom√®tre</div><div class="product-ref">1977</div></div><div class="product-price">65‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="65" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="59"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Support Potentiom√®tre</div><div class="product-ref">A9A15152</div></div><div class="product-price">8.50‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="8.5" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>
            </div>

            <!-- R√©cap produits ajout√©s (vue admin, comme c√¥t√© technicien) -->
            <div class="section">
                <h3 class="section-title">R√©capitulatif des produits ajout√©s</h3>
                <div id="selectedProductsListAdmin" style="font-size:0.9rem; border:1px solid var(--border); border-radius:8px; padding:10px 12px; background:#f8fafc;">
                    <p style="color:var(--text-light);">Aucun produit s√©lectionn√© pour le moment.</p>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">Main d'≈íuvre & D√©placement</h3>
                <div class="service-row">
                    <label>üîß Main d'≈ìuvre</label>
                    <input type="text" id="moDuree" value="0h00" readonly style="background:#f0f0f0; cursor:not-allowed;" placeholder="Dur√©e">
                    <input type="text" id="moDemiHeures" value="0 demi-heures" readonly style="background:#f0f0f0; cursor:not-allowed; text-align:center; display:none;" placeholder="Demi-heures">
                    <input type="number" id="moTarif" value="35" min="0" placeholder="‚Ç¨/demi-h" style="display:none;">
                    <div class="product-total" id="moTotal">0.00‚Ç¨</div>
                </div>
                <div class="service-row">
                    <label>üöó D√©placement (70‚Ç¨/d√©placement)</label>
                    <input type="number" id="deplNombre" value="0" min="0" max="10" placeholder="0, 1, 2..." onchange="updateDepl()">
                    <input type="number" id="deplTarif" value="70" min="0" style="display:none;">
                    <div class="product-total" id="deplTotal">0.00‚Ç¨</div>
                </div>
            </div>

            <div class="totals-section">
                <div class="total-row"><span>Sous-total Produits</span><span id="subtotalProduits">0.00‚Ç¨</span></div>
                <div class="total-row"><span>Main d'≈ìuvre</span><span id="subtotalMO">0.00‚Ç¨</span></div>
                <div class="total-row"><span>D√©placement</span><span id="subtotalDepl">0.00‚Ç¨</span></div>
                <div class="total-row"><span>Total HT</span><span id="totalHT">0.00‚Ç¨</span></div>
                <div class="total-row"><span>TVA (20%)</span><span id="totalTVA">0.00‚Ç¨</span></div>
                <div class="total-row grand-total"><span>TOTAL TTC</span><span id="totalTTC">0.00‚Ç¨</span></div>
            </div>

            <div class="signature-section">
                <div class="signature-box">
                    <h4>Signature Technicien</h4>
                    <canvas class="signature-canvas" id="signatureTech"></canvas>
                    <div class="signature-actions"><button class="btn-clear" onclick="clearSignature('signatureTech')">Effacer</button></div>
                </div>
                <div class="signature-box">
                    <h4>Signature Client</h4>
                    <canvas class="signature-canvas" id="signatureClient"></canvas>
                    <div class="signature-actions"><button class="btn-clear" onclick="clearSignature('signatureClient')">Effacer</button></div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Imprimer</button>
                <button class="btn btn-primary" onclick="saveBon()">üíæ Enregistrer le bon</button>
                <button class="btn btn-primary" onclick="envoyerCompta()">üìß Envoyer en Comptabilit√©</button>
            </div>
        </div>

            <!-- Historique des bons -->
            <div class="section">
                <h3 class="section-title">Historique des bons enregistr√©s</h3>
                <div style="margin-bottom:10px;">
                    <button id="btnSupprimerSelection" onclick="supprimerBonsSelectionnes()" style="padding:8px 16px; background:#e53e3e; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9rem; display:none;" disabled>
                        Supprimer la s√©lection (<span id="nbSelectionnes">0</span>)
                    </button>
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                        <thead>
                            <tr style="background:#edf2f7;">
                                <th style="text-align:center; padding:8px; border-bottom:1px solid var(--border); width:40px;">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="cursor:pointer;">
                                </th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Date</th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">N¬∞ Bon</th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Client</th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Technicien</th>
                                <th style="text-align:right; padding:8px; border-bottom:1px solid var(--border);">Total TTC</th>
                                <th style="text-align:center; padding:8px; border-bottom:1px solid var(--border); width:160px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bonsTableBody">
                            <!-- rempli en JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Gestion des clients -->
            <div class="section">
                <h3 class="section-title">Gestion des clients</h3>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" onclick="exporterClientsExcel()" style="padding: 10px 20px; font-size: 1rem;">
                        üì• Exporter la liste des clients vers Excel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('excelFileInput').click()" style="padding: 10px 20px; font-size: 1rem;">
                        üì§ Importer des clients depuis Excel
                    </button>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="importerClientsExcel(event)">
                </div>
                <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 10px;">
                    <strong>Export :</strong> Exportez tous les clients enregistr√©s dans un fichier Excel pour sauvegarde ou transfert.
                </p>
                <p style="color: var(--text-light); font-size: 0.9rem;">
                    <strong>Import :</strong> Importez des clients depuis un fichier Excel. Format attendu : Colonnes "Nom", "Email", "T√©l√©phone", "Adresse" (premi√®re ligne = en-t√™tes). Les clients avec le m√™me email seront mis √† jour.
                </p>
            </div>

        <div class="footer">Compagnie d'√âlectricit√© Parisienne ‚Äî Bon d'intervention (Admin)</div>
    </div>

    <!-- Lightbox d'aper√ßu des photos -->
    <div id="photoLightbox" class="photo-lightbox" onclick="closePhotoLightbox()">
        <button type="button" class="photo-lightbox-close" onclick="closePhotoLightbox(); event.stopPropagation();">√ó</button>
        <img id="photoLightboxImg" src="" alt="Aper√ßu photo">
    </div>

    <!-- Firebase v8 (app + firestore + storage) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script>
        let currentBonId = null; // id du document Firestore courant
        let photosAdmin = [];

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAuX2gsGiRGqVbsk93y0wmwJOsT-RuEkE4",
            authDomain: "bon-d-intervention-cep.firebaseapp.com",
            projectId: "bon-d-intervention-cep",
            storageBucket: "bon-d-intervention-cep.firebasestorage.app",
            messagingSenderId: "323636987494",
            appId: "1:323636987494:web:0b07cffbb086c767320fa7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ============================================
        // CONFIGURATION EMAILJS
        // ============================================
        // IMPORTANT: V√©rifiez vos IDs dans le dashboard EmailJS:
        // https://dashboard.emailjs.com/admin
        // 
        // Pour trouver vos IDs:
        // 1. Allez dans "Email Services" ‚Üí copiez votre Service ID (format: service_xxxxxxx)
        // 2. Allez dans "Email Templates" ‚Üí copiez votre Template ID (format: template_xxxxxxx)
        // 3. Remplacez les valeurs ci-dessous avec vos IDs r√©els
        // ============================================
        const EMAILJS_CONFIG = {
            publicKey: "GXDaMfa8u-ZzmkvNn",  // Public Key (d√©j√† dans emailjs.init)
            serviceID: "service_b6ibqvh",     // Service ID depuis le dashboard EmailJS
            templateID: "template_qsnhl5e",  // Template ID depuis le dashboard EmailJS
            emailDest: "a.mathieu@elechosystem.com"  // Email de destination
        };
        // ============================================
        
        // ============================================
        // CONFIGURATION SMTP OVH (pour envoi comptabilit√© avec PDF)
        // ============================================
        const SMTP_API_URL = 'https://bon-intervention-cep.vercel.app/api/send-email';
        // ============================================

        // Utilise le m√™me compteur que la page technicien si besoin de cr√©er un nouveau bon vierge
        function getNextBonNumberFromStorage() {
            const today = new Date();
            const year = today.getFullYear();
            let lastYear = parseInt(localStorage.getItem('cep_lastBonYear') || '0', 10);
            let lastSeq = parseInt(localStorage.getItem('cep_lastBonSeq') || '0', 10);

            if (lastYear !== year) {
                lastYear = year;
                lastSeq = 0;
            }
            lastSeq += 1;

            localStorage.setItem('cep_lastBonYear', String(lastYear));
            localStorage.setItem('cep_lastBonSeq', String(lastSeq));

            return 'CEP-' + lastYear + '-' + String(lastSeq).padStart(4, '0');
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Protection par code admin
            // V√©rifier si l'utilisateur est d√©j√† authentifi√© (venant de index.html)
            const isAuthenticated = sessionStorage.getItem('adminAuthenticated') === 'true';
            
            if (!isAuthenticated) {
                // Si pas authentifi√©, demander le code
                const code = prompt("Code administrateur :");
                if (code !== "CEP2024") {
                    alert("Code incorrect. Retour √† la page technicien.");
                    window.location.href = "index.html";
                    return;
                }
                // Stocker l'authentification
                sessionStorage.setItem('adminAuthenticated', 'true');
            }

            const today = new Date();
            document.getElementById('currentDate').textContent = today.toLocaleDateString('fr-FR');
            document.getElementById('interventionDate').valueAsDate = today;
            initSignature('signatureTech');
            initSignature('signatureClient');
            renderHistorique();
        });

        function toggleCategory(header) {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('hidden');
        }

        function addMaterial() {
            const select = document.getElementById('materialSelect');
            const qtyInput = document.getElementById('materialQty');
            const index = select.value;
            const qty = parseInt(qtyInput.value) || 1;
            
            if (index === '') {
                alert('Veuillez s√©lectionner un produit');
                return;
            }
            
            const row = document.querySelector(`.product-row[data-index="${index}"]`);
            if (row) {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const qtyField = row.querySelector('.product-qty input');
                const currentQty = parseInt(qtyField.value) || 0;
                
                qtyField.value = currentQty + qty;
                checkbox.checked = true;
                row.classList.add('selected');
                updateRowTotal(qtyField);

                // Ne plus ouvrir automatiquement les cat√©gories ni scroller :
                // l'admin peut v√©rifier via les champs et les totaux.
            }
            
            select.value = '';
            qtyInput.value = 1;
        }

        function updateRowTotal(input) {
            const row = input.closest('.product-row');
            const checkbox = row.querySelector('input[type="checkbox"]');
            const qty = parseFloat(input.value) || 0;
            const price = parseFloat(input.dataset.price) || 0;
            row.querySelector('.product-total').textContent = (qty * price).toFixed(2) + '‚Ç¨';
            checkbox.checked = qty > 0;
            row.classList.toggle('selected', qty > 0);
            calculateTotals();
        }

        function updateTotal(checkbox) {
            const row = checkbox.closest('.product-row');
            row.classList.toggle('selected', checkbox.checked);
            if (!checkbox.checked) {
                row.querySelector('.product-qty input').value = 0;
                row.querySelector('.product-total').textContent = '0.00‚Ç¨';
            }
            calculateTotals();
        }

        function calculerMainOeuvre() {
            const heureArrivee = document.getElementById('heureArrivee').value;
            const heureDepart = document.getElementById('heureDepart').value;
            
            if (!heureArrivee || !heureDepart) {
                document.getElementById('moDuree').value = '0h00';
                document.getElementById('moDemiHeures').value = '0 demi-heures';
                document.getElementById('moTotal').textContent = '0.00‚Ç¨';
                calculateTotals();
                return;
            }
            
            // Convertir les heures en minutes
            const [hArr, mArr] = heureArrivee.split(':').map(Number);
            const [hDep, mDep] = heureDepart.split(':').map(Number);
            const minutesArrivee = hArr * 60 + mArr;
            const minutesDepart = hDep * 60 + mDep;
            
            // Calculer la dur√©e en minutes
            let dureeMinutes = minutesDepart - minutesArrivee;
            
            // G√©rer le cas o√π le d√©part est le lendemain (apr√®s minuit)
            if (dureeMinutes < 0) {
                dureeMinutes += 24 * 60; // Ajouter 24 heures
            }
            
            // Convertir en heures et minutes pour l'affichage
            const heures = Math.floor(dureeMinutes / 60);
            const minutes = dureeMinutes % 60;
            document.getElementById('moDuree').value = heures + 'h' + String(minutes).padStart(2, '0');
            
            // Calculer le nombre de demi-heures (arrondi au demi-heure sup√©rieur)
            const demiHeures = Math.ceil(dureeMinutes / 30);
            document.getElementById('moDemiHeures').value = demiHeures + ' demi-heure' + (demiHeures > 1 ? 's' : '');
            
            // Calculer le total : nombre de demi-heures √ó 35‚Ç¨
            const tarifDemiHeure = 35;
            const totalMO = demiHeures * tarifDemiHeure;
            document.getElementById('moTotal').textContent = totalMO.toFixed(2) + '‚Ç¨';
            
            calculateTotals();
        }

        function updateMO() {
            // Cette fonction n'est plus utilis√©e, mais on la garde pour compatibilit√©
            calculerMainOeuvre();
        }

        function updateDepl() {
            const nombre = parseFloat(document.getElementById('deplNombre').value) || 0;
            const tarifForfait = 70; // 70‚Ç¨ par d√©placement
            const total = nombre * tarifForfait;
            document.getElementById('deplTotal').textContent = total.toFixed(2) + '‚Ç¨';
            calculateTotals();
        }

        function calculateTotals() {
            let sub = 0;
            document.querySelectorAll('.product-row').forEach(row => {
                if (row.querySelector('input[type="checkbox"]')?.checked) {
                    sub += parseFloat(row.querySelector('.product-total').textContent) || 0;
                }
            });
            const mo = parseFloat(document.getElementById('moTotal').textContent) || 0;
            const depl = parseFloat(document.getElementById('deplTotal').textContent) || 0;
            const ht = sub + mo + depl;
            const tva = ht * 0.2;
            document.getElementById('subtotalProduits').textContent = sub.toFixed(2) + '‚Ç¨';
            document.getElementById('subtotalMO').textContent = mo.toFixed(2) + '‚Ç¨';
            document.getElementById('subtotalDepl').textContent = depl.toFixed(2) + '‚Ç¨';
            document.getElementById('totalHT').textContent = ht.toFixed(2) + '‚Ç¨';
            document.getElementById('totalTVA').textContent = tva.toFixed(2) + '‚Ç¨';
            document.getElementById('totalTTC').textContent = (ht + tva).toFixed(2) + '‚Ç¨';

            // R√©cap produits pour l'admin (comme c√¥t√© technicien)
            const container = document.getElementById('selectedProductsListAdmin');
            if (container) {
                const lignes = [];
                document.querySelectorAll('.product-row').forEach(row => {
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    const qtyInput = row.querySelector('.product-qty input');
                    const qty = parseFloat(qtyInput.value) || 0;
                    if (checkbox && checkbox.checked && qty > 0) {
                        const name = row.querySelector('.product-name')?.textContent || '';
                        const ref = row.querySelector('.product-ref')?.textContent || '';
                        const prixUnitaire = parseFloat(qtyInput.dataset.price || 0).toFixed(2);
                        const totalLigne = row.querySelector('.product-total')?.textContent || '';
                        lignes.push({ name, ref, qty, prixUnitaire, total: totalLigne });
                    }
                });

                if (lignes.length === 0) {
                    container.innerHTML = "<p style=\"color:var(--text-light);\">Aucun produit s√©lectionn√© pour le moment.</p>";
                } else {
                    container.innerHTML = lignes.map(l => 
                        `<div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed var(--border);">
                            <span>${l.name}${l.ref ? ' <span style="color:var(--text-light); font-size:0.8em;">(' + l.ref + ')</span>' : ''}</span>
                            <span style="font-family:'Space Mono', monospace;">Qt√© : ${l.qty} √ó ${l.prixUnitaire}‚Ç¨ = ${l.total}</span>
                        </div>`
                    ).join("");
                }
            }
        }

        function initSignature(id) {
            const canvas = document.getElementById(id);
            const ctx = canvas.getContext('2d');
            let drawing = false;
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.strokeStyle = '#1a365d';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';

            function pos(e) {
                const r = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - r.left;
                const y = (e.clientY || e.touches[0].clientY) - r.top;
                return {x, y};
            }
            canvas.onmousedown = e => { drawing = true; ctx.beginPath(); ctx.moveTo(pos(e).x, pos(e).y); };
            canvas.onmousemove = e => { if (drawing) { ctx.lineTo(pos(e).x, pos(e).y); ctx.stroke(); } };
            canvas.onmouseup = canvas.onmouseout = () => drawing = false;
            canvas.ontouchstart = e => { e.preventDefault(); drawing = true; ctx.beginPath(); ctx.moveTo(pos(e).x, pos(e).y); };
            canvas.ontouchmove = e => { e.preventDefault(); if (drawing) { ctx.lineTo(pos(e).x, pos(e).y); ctx.stroke(); } };
            canvas.ontouchend = () => drawing = false;
        }

        function clearSignature(id) {
            const c = document.getElementById(id);
            c.getContext('2d').clearRect(0, 0, c.width, c.height);
        }

        async function envoyerClient() {
            if (!currentBonId) {
                alert("Charge d'abord un bon avant de l'envoyer au client.");
                return;
            }
            
            const email = (document.getElementById('clientEmail').value || '').trim();
            if (!email) {
                alert("Veuillez renseigner l'email du client avant d'envoyer.");
                return;
            }
            
            try {
                console.log('=== D√âBUT ENVOI EMAIL CLIENT DEPUIS ADMIN ===');
                const numeroBon = document.getElementById('bonNumber').textContent;
                const client = document.getElementById('clientName').value || 'Client';
                
                console.log('Num√©ro bon:', numeroBon);
                console.log('Client:', client);
                console.log('Email:', email);
                
                // G√©n√©rer le lien de paiement uniquement quand on envoie depuis l'admin
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const paymentLink = isLocal 
                    ? `${window.location.origin}/BI-${numeroBon}`
                    : `https://pay.elecho-system.com/BI-${numeroBon}`;
                
                console.log('Lien de paiement g√©n√©r√©:', paymentLink);
                
                // Mettre √† jour le bon avec le lien de paiement AVANT de g√©n√©rer le PDF
                console.log('Mise √† jour du bon dans Firebase...');
                await db.collection('bons').doc(currentBonId).update({
                    paymentLink: paymentLink,
                    paymentStatus: 'pending',
                    paymentDate: null,
                    paymentAmount: null
                });
                console.log('Bon mis √† jour dans Firebase');
                
                // G√©n√©rer et envoyer le PDF avec le lien de paiement (passer le lien directement)
                console.log('G√©n√©ration du PDF...');
                const pdfBlob = await genererPDFBon(paymentLink);
                console.log('PDF g√©n√©r√©, taille:', pdfBlob.size, 'bytes');
                
                const pdfBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result.split(',')[1];
                        console.log('PDF converti en base64, longueur:', base64String.length);
                        resolve(base64String);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(pdfBlob);
                });
                
                // R√©cup√©rer les photos depuis Firebase si disponibles
                let photosPourEmail = [];
                try {
                    if (currentBonId) {
                        const bonDoc = await db.collection('bons').doc(currentBonId).get();
                        if (bonDoc.exists) {
                            const bonData = bonDoc.data();
                            if (bonData.photos && Array.isArray(bonData.photos)) {
                                // Les photos dans Firebase sont des URLs, on ne peut pas les utiliser directement
                                // Pour l'instant, on n'envoie pas les photos dans l'email depuis admin
                                photosPourEmail = [];
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Erreur r√©cup√©ration photos:', e);
                }
                
                const bonData = {
                    numero: numeroBon,
                    date: document.getElementById('interventionDate').value || '',
                    client: client,
                    adresse: document.getElementById('clientAddress').value || '',
                    telephone: document.getElementById('clientPhone').value || '',
                    technicien: document.getElementById('technicien').value || '',
                    description: document.getElementById('description').value || '',
                    heure_arrivee: document.getElementById('heureArrivee').value || '',
                    heure_depart: document.getElementById('heureDepart').value || ''
                };
                
                console.log('Envoi de l\'email via SMTP...');
                await envoyerEmailAvecPDFSMTP({
                    email: email,
                    subject: `Bon d'intervention ${numeroBon} - ${client}`,
                    pdfBase64: pdfBase64,
                    pdfFileName: `bon-intervention-${numeroBon}.pdf`,
                    bonData: bonData,
                    photos: photosPourEmail
                });
                
                console.log('‚úÖ Email envoy√© avec succ√®s');
                alert(`‚úÖ Email envoy√© au client avec succ√®s !\n\nLe lien de paiement a √©t√© g√©n√©r√© et inclus dans le PDF.`);
                
            } catch (error) {
                console.error('‚ùå Erreur envoi client:', error);
                console.error('Stack:', error.stack);
                alert("‚ö†Ô∏è Erreur lors de l'envoi de l'email au client: " + (error.message || error) + "\n\nV√©rifiez la console (F12) pour plus de d√©tails.");
            }
        }

        async function envoyerCompta() {
            if (!currentBonId) {
                alert("Charge d'abord un bon avant de l'envoyer en comptabilit√©.");
                return;
            }

            try {
                // S'assurer que le bon a un num√©ro d√©finitif et est bien sauvegard√©
                await saveBon();

                // R√©cup√©rer les donn√©es du bon depuis Firestore
                const doc = await db.collection('bons').doc(currentBonId).get();
                if (!doc.exists) {
                    alert("Bon introuvable.");
                    return;
                }
                const bonData = doc.data();

                // Mettre √† jour le statut en 'valid√©'
                await db.collection('bons').doc(currentBonId).update({ statut: 'valid√©' });

                // R√©cup√©rer les informations du formulaire
                const numeroBon = document.getElementById('bonNumber').textContent;
                const date = document.getElementById('interventionDate').value || bonData.date || '';
                const client = document.getElementById('clientName').value || bonData.client || 'Client';
                const clientPhone = document.getElementById('clientPhone').value || bonData.phone || '';
                const clientEmail = document.getElementById('clientEmail').value || bonData.email || '';
                const clientAddress = document.getElementById('clientAddress').value || bonData.address || '';
                const technicien = document.getElementById('technicien').value || bonData.technicien || 'Non sp√©cifi√©';
                const description = document.getElementById('description').value || bonData.description || '';
                
                // Main d'≈ìuvre
                const moDuree = document.getElementById('moDuree').value || bonData.moDuree || '0h00';
                const moDemiHeures = document.getElementById('moDemiHeures').value || bonData.moDemiHeures || '0 demi-heures';
                const moTotal = document.getElementById('subtotalMO').textContent || bonData.subtotalMO || '0.00‚Ç¨';
                
                // D√©placement
                const deplNombre = document.getElementById('deplNombre').value || bonData.deplNombre || '0';
                const deplTotal = document.getElementById('subtotalDepl').textContent || bonData.subtotalDepl || '0.00‚Ç¨';
                
                // Totaux
                const subtotalProduits = document.getElementById('subtotalProduits').textContent || bonData.subtotalProduits || '0.00‚Ç¨';
                const totalHT = document.getElementById('totalHT').textContent || bonData.totalHT || '0.00‚Ç¨';
                const totalTVA = document.getElementById('totalTVA').textContent || bonData.totalTVA || '0.00‚Ç¨';
                const totalTTC = document.getElementById('totalTTC').textContent || bonData.totalTTC || '0.00‚Ç¨';
                
                // R√©cup√©rer les produits
                let produitsHtml = '';
                if (bonData.produits && Array.isArray(bonData.produits) && bonData.produits.length > 0) {
                    produitsHtml = '\n\nüì¶ MAT√âRIEL UTILIS√â :\n';
                    produitsHtml += '‚îÄ'.repeat(50) + '\n';
                    bonData.produits.forEach(p => {
                        produitsHtml += `‚Ä¢ ${p.nom || ''}`;
                        if (p.reference) produitsHtml += ` (R√©f: ${p.reference})`;
                        produitsHtml += `\n  Quantit√©: ${p.quantite || 0}`;
                        produitsHtml += ` | Prix unitaire: ${(p.prixUnitaire || 0).toFixed(2)}‚Ç¨`;
                        produitsHtml += ` | Total: ${((p.prixUnitaire || 0) * (p.quantite || 0)).toFixed(2)}‚Ç¨\n\n`;
                    });
                } else {
                    produitsHtml = '\n\nüì¶ MAT√âRIEL UTILIS√â : Aucun\n';
                }
                
                // R√©cup√©rer les photos
                let photosHtml = '';
                if (bonData.photos && Array.isArray(bonData.photos) && bonData.photos.length > 0) {
                    photosHtml = '\n\nüì∑ PHOTOS DE L\'INTERVENTION :\n';
                    photosHtml += '‚îÄ'.repeat(50) + '\n';
                    bonData.photos.forEach((url, index) => {
                        photosHtml += `Photo ${index + 1}: ${url}\n`;
                    });
                } else {
                    photosHtml = '\n\nüì∑ PHOTOS : Aucune photo\n';
                }
                
                // Construire le corps de l'email pour EmailJS
                let body = `BON D'INTERVENTION ${numeroBon}\n`;
                body += '‚ïê'.repeat(50) + '\n\n';
                body += `üìÖ Date : ${date}\n`;
                body += `üë§ Client : ${client}\n`;
                if (clientPhone) body += `üìû T√©l√©phone : ${clientPhone}\n`;
                if (clientEmail) body += `üìß Email : ${clientEmail}\n`;
                if (clientAddress) body += `üìç Adresse : ${clientAddress}\n`;
                body += `üîß Technicien : ${technicien}\n`;
                if (description) body += `üìù Description : ${description}\n`;
                
                body += produitsHtml;
                
                body += '\nüí∞ MAIN D\'≈íUVRE :\n';
                body += '‚îÄ'.repeat(50) + '\n';
                body += `Dur√©e : ${moDuree}\n`;
                body += `Nombre de demi-heures : ${moDemiHeures}\n`;
                body += `Montant : ${moTotal}\n`;
                
                body += '\nüöó D√âPLACEMENT :\n';
                body += '‚îÄ'.repeat(50) + '\n';
                body += `Nombre de d√©placements : ${deplNombre}\n`;
                body += `Montant : ${deplTotal}\n`;
                
                body += '\nüí∂ R√âCAPITULATIF :\n';
                body += '‚îÄ'.repeat(50) + '\n';
                body += `Sous-total Produits : ${subtotalProduits}\n`;
                body += `Main d'≈ìuvre : ${moTotal}\n`;
                body += `D√©placement : ${deplTotal}\n`;
                body += `Total HT : ${totalHT}\n`;
                body += `TVA (20%) : ${totalTVA}\n`;
                body += `TOTAL TTC : ${totalTTC}\n`;
                
                body += photosHtml;
                
                body += '\n\n‚îÄ'.repeat(50) + '\n';
                body += 'Compagnie d\'√âlectricit√© Parisienne\n';
                body += 'Bon g√©n√©r√© automatiquement\n';
                
                // R√©cup√©rer les heures d'arriv√©e et de d√©part
                const heureArrivee = document.getElementById('heureArrivee').value || '';
                const heureDepart = document.getElementById('heureDepart').value || '';
                
                // G√©n√©rer le PDF et l'envoyer en pi√®ce jointe via SMTP OVH
                try {
                    console.log('=== D√âBUT G√âN√âRATION PDF POUR COMPTABILIT√â ===');
                    console.log('V√©rification jsPDF...', typeof window.jspdf !== 'undefined');
                    
                    if (typeof window.jspdf === 'undefined') {
                        throw new Error("jsPDF n'est pas charg√©. Veuillez recharger la page.");
                    }
                    
                    console.log('G√©n√©ration du PDF en cours...');
                    const pdfBlob = await genererPDFBon();
                    
                    if (!pdfBlob || pdfBlob.size === 0) {
                        throw new Error('Le PDF g√©n√©r√© est vide ou invalide');
                    }
                    
                    console.log('‚úÖ PDF g√©n√©r√© avec succ√®s, taille:', pdfBlob.size, 'bytes');
                    
                    // Convertir le PDF en base64 pour l'envoyer via l'API
                    console.log('Conversion du PDF en base64...');
                    const pdfBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            try {
                                const base64String = reader.result.split(',')[1]; // Enlever le pr√©fixe data:application/pdf;base64,
                                if (!base64String || base64String.length === 0) {
                                    reject(new Error('Erreur lors de la conversion en base64: cha√Æne vide'));
                                    return;
                                }
                                console.log('‚úÖ PDF converti en base64, longueur:', base64String.length, 'caract√®res');
                                resolve(base64String);
                            } catch (err) {
                                reject(new Error('Erreur lors de la conversion en base64: ' + err.message));
                            }
                        };
                        reader.onerror = (error) => {
                            reject(new Error('Erreur FileReader: ' + error));
                        };
                        reader.readAsDataURL(pdfBlob);
                    });
                    
                    // Pr√©parer les donn√©es du bon pour l'email
                    const bonData = {
                        numero: numeroBon,
                        date: date,
                        client: client,
                        adresse: clientAddress,
                        telephone: clientPhone,
                        technicien: technicien,
                        description: description,
                        heure_arrivee: heureArrivee,
                        heure_depart: heureDepart
                    };
                    
                    // Envoyer l'email avec PDF en pi√®ce jointe via SMTP OVH (Nodemailer)
                    console.log('=== PR√âPARATION ENVOI EMAIL COMPTABILIT√â ===');
                    console.log('Email destinataire:', "a.mathieu@elechosystem.com");
                    console.log('Sujet:', `Bon d'intervention ${numeroBon} - ${client}`);
                    console.log('Taille PDF base64:', pdfBase64.length, 'caract√®res');
                    
                    await envoyerEmailAvecPDFSMTP({
                        email: "a.mathieu@elechosystem.com",
                        subject: `Bon d'intervention ${numeroBon} - ${client}`,
                        pdfBase64: pdfBase64,
                        pdfFileName: `bon-intervention-${numeroBon}.pdf`,
                        bonData: bonData
                    });
                    
                    console.log('‚úÖ Email envoy√© avec succ√®s √† la comptabilit√©');
                    
                } catch (pdfError) {
                    console.error('‚ùå ERREUR lors de la g√©n√©ration/envoi du PDF:', pdfError);
                    console.error('Type d\'erreur:', typeof pdfError);
                    console.error('Message:', pdfError.message);
                    console.error('Stack:', pdfError.stack);
                    console.error('D√©tails complets:', pdfError);
                    
                    let errorMsg = "‚ö†Ô∏è Erreur lors de l'envoi de l'email avec PDF √† la comptabilit√©.\n\n";
                    errorMsg += "Erreur: " + (pdfError.message || pdfError.toString() || 'Erreur inconnue');
                    errorMsg += "\n\nV√©rifiez la console du navigateur (F12) pour plus de d√©tails.";
                    
                    alert(errorMsg);
                    throw pdfError;
                }

                await renderHistorique();
            } catch (e) {
                console.error(e);
                alert("Erreur lors de la validation / envoi √† la comptabilit√©: " + (e.message || e));
            }
        }

        // Filtre de recherche rapide dans l'ascenseur produits (admin)
        function filterMaterialsAdmin() {
            const term = (document.getElementById('materialSearchAdmin').value || '').toLowerCase();
            const select = document.getElementById('materialSelect');
            if (!select) return;
            Array.from(select.options).forEach(opt => {
                if (opt.value === '') {
                    opt.hidden = false;
                    return;
                }
                const text = opt.textContent.toLowerCase();
                opt.hidden = term && !text.includes(term);
            });
        }

        // --- Gestion de l'historique des bons (stockage local navigateur) ---

        async function saveBon() {
            if (!currentBonId) {
                alert("Pour l'admin : charge d'abord un bon existant depuis l'historique, puis modifie et enregistre.");
                return;
            }

            // Si le bon n'a pas encore de num√©ro d√©finitif (brouillon), on en g√©n√®re un ici
            let numeroActuel = document.getElementById('bonNumber').textContent || '';
            if (!numeroActuel || numeroActuel.startsWith('BROUILLON')) {
                numeroActuel = getNextBonNumberFromStorage();
                document.getElementById('bonNumber').textContent = numeroActuel;
            }

            const bon = {
                id: currentBonId,
                numero: numeroActuel,
                date: document.getElementById('interventionDate').value || new Date().toISOString().slice(0,10),
                client: document.getElementById('clientName').value || '',
                phone: document.getElementById('clientPhone').value || '',
                email: document.getElementById('clientEmail').value || '',
                address: document.getElementById('clientAddress').value || '',
                technicien: document.getElementById('technicien').value || '',
                description: document.getElementById('description').value || '',
                heureArrivee: document.getElementById('heureArrivee').value || '',
                heureDepart: document.getElementById('heureDepart').value || '',
                moDuree: document.getElementById('moDuree').value || '0h00',
                moDemiHeures: document.getElementById('moDemiHeures').value || '0 demi-heures',
                moTarif: document.getElementById('moTarif').value || '35',
                deplNombre: document.getElementById('deplNombre').value || '0',
                deplTarif: document.getElementById('deplTarif').value || '0',
                subtotalProduits: document.getElementById('subtotalProduits').textContent || '0.00‚Ç¨',
                subtotalMO: document.getElementById('subtotalMO').textContent || '0.00‚Ç¨',
                subtotalDepl: document.getElementById('subtotalDepl').textContent || '0.00‚Ç¨',
                totalHT: document.getElementById('totalHT').textContent || '0.00‚Ç¨',
                totalTVA: document.getElementById('totalTVA').textContent || '0.00‚Ç¨',
                totalTTC: document.getElementById('totalTTC').textContent || '0.00‚Ç¨',
                produits: []
            };

            // Sauvegarder les quantit√©s de produits s√©lectionn√©s
            document.querySelectorAll('.product-row').forEach(row => {
                const index = row.dataset.index;
                const qtyInput = row.querySelector('.product-qty input');
                const qty = parseFloat(qtyInput.value) || 0;
                if (qty > 0) {
                    const name = row.querySelector('.product-name')?.textContent || '';
                    bon.produits.push({ index, name, qty });
                }
            });

            try {
                await db.collection('bons').doc(currentBonId).update(bon);
                await renderHistorique();
                alert("Modifications enregistr√©es pour ce bon (Firestore).");
            } catch (e) {
                console.error(e);
                alert("Erreur lors de l'enregistrement du bon (Firestore).");
            }
        }

        async function renderHistorique() {
            const tbody = document.getElementById('bonsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            try {
                // Charger tous les bons (en_attente et valid√©)
                const snap = await db.collection('bons').get();
                const bons = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    bons.push({ id: doc.id, ...data });
                });

                bons.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                bons.forEach(bon => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-bon-id', bon.id);
                const statut = bon.statut || 'en_attente';
                const estValide = statut === 'valid√©' || statut === 'valide';
                
                // Badge pour les bons valid√©s
                const badgeStatut = estValide 
                    ? '<span style="background:#48bb78;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.7rem;margin-right:4px;">‚úì Envoy√© √† la compta</span>'
                    : '<span style="background:#f6ad55;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.7rem;margin-right:4px;">En attente</span>';
                
                // Bouton supprimer selon le statut
                const boutonSupprimer = estValide
                    ? '<button style="padding:4px 8px; font-size:0.75rem; background:#e53e3e; color:#fff; border:none; border-radius:4px;" onclick="supprimerBon(\'' + bon.id + '\', \'' + statut + '\')" title="Supprimer (code admin requis)">Supprimer (admin)</button>'
                    : '<button style="padding:4px 8px; font-size:0.75rem; background:#e53e3e; color:#fff; border:none; border-radius:4px;" onclick="supprimerBon(\'' + bon.id + '\', \'' + statut + '\')">Supprimer</button>';
                
                tr.innerHTML = `
                    <td style="padding:6px 8px; border-bottom:1px solid var(--border); text-align:center;">
                        <input type="checkbox" class="bon-checkbox" data-bon-id="${bon.id}" data-statut="${statut}" onchange="updateSelectionCount()" style="cursor:pointer;">
                    </td>
                    <td style="padding:6px 8px; border-bottom:1px solid var(--border);">${bon.date}</td>
                    <td style="padding:6px 8px; border-bottom:1px solid var(--border); font-family:'Space Mono', monospace;">${bon.numero || ''}</td>
                    <td style="padding:6px 8px; border-bottom:1px solid var(--border);">${bon.client}</td>
                    <td style="padding:6px 8px; border-bottom:1px solid var(--border);">${bon.technicien}</td>
                    <td style="padding:6px 8px; border-bottom:1px solid var(--border); text-align:right;">${bon.totalTTC}</td>
                    <td style="padding:6px 8px; border-bottom:1px solid var(--border); text-align:center;">
                        ${badgeStatut}
                        <button style="margin-right:6px; padding:4px 8px; font-size:0.75rem;" onclick="chargerBon('${bon.id}')">Charger</button>
                        ${boutonSupprimer}
                    </td>
                `;
                tbody.appendChild(tr);
                });
                
                // R√©initialiser la s√©lection apr√®s le chargement
                updateSelectionCount();
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="7" style="padding:8px; text-align:center; color:var(--text-light);">Erreur de chargement des bons.</td></tr>';
            }
        }

        async function chargerBon(id) {
            try {
                const doc = await db.collection('bons').doc(id).get();
                if (!doc.exists) {
                    alert("Bon introuvable.");
                    return;
                }
                const bon = doc.data();
                console.log('=== D√âBOGAGE CHARGEMENT BON ===');
                console.log('Bon complet:', bon);
                console.log('Statut:', bon.statut);
                console.log('Champ photos:', bon.photos);
                console.log('Type photos:', typeof bon.photos);
                console.log('Est un tableau?', Array.isArray(bon.photos));
                console.log('Nombre de photos:', bon.photos ? bon.photos.length : 0);
                console.log('URLs photos:', bon.photos);
                console.log('Produits:', bon.produits);

                currentBonId = id;
                
                // V√©rifier si le bon est valid√© (prot√©g√©)
                const estValide = bon.statut === 'valid√©' || bon.statut === 'valide';
                const estModifiable = !estValide;
                
                // Afficher un message si le bon est valid√©
                if (estValide) {
                    const msgExistant = document.getElementById('bonValideMessage');
                    if (msgExistant) msgExistant.remove();
                    
                    const msg = document.createElement('div');
                    msg.id = 'bonValideMessage';
                    msg.style.cssText = 'background:#48bb78;color:#fff;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;font-weight:600;';
                    msg.textContent = '‚úì Ce bon a √©t√© envoy√© √† la comptabilit√© et ne peut plus √™tre modifi√©.';
                    const formBody = document.querySelector('.form-body');
                    if (formBody) formBody.insertBefore(msg, formBody.firstChild);
                } else {
                    const msgExistant = document.getElementById('bonValideMessage');
                    if (msgExistant) msgExistant.remove();
                }

            document.getElementById('bonNumber').textContent = bon.numero;
            document.getElementById('interventionDate').value = bon.date;
            document.getElementById('clientName').value = bon.client;
            document.getElementById('clientPhone').value = bon.phone;
            document.getElementById('clientEmail').value = bon.email;
            document.getElementById('clientAddress').value = bon.address;
            document.getElementById('technicien').value = bon.technicien;
            document.getElementById('description').value = bon.description;
            document.getElementById('heureArrivee').value = bon.heureArrivee || '';
            document.getElementById('heureDepart').value = bon.heureDepart || '';
            document.getElementById('moDuree').value = bon.moDuree || '0h00';
            document.getElementById('moDemiHeures').value = bon.moDemiHeures || '0 demi-heures';
            document.getElementById('moTarif').value = bon.moTarif || '35';
            // Recalculer la main d'≈ìuvre si les heures sont pr√©sentes
            if (bon.heureArrivee && bon.heureDepart) {
                calculerMainOeuvre();
            }
            document.getElementById('deplNombre').value = bon.deplNombre || bon.deplKm || '0';
            document.getElementById('deplTarif').value = '70';
            updateDepl();

            // Remettre tous les produits √† z√©ro
            document.querySelectorAll('.product-row').forEach(row => {
                row.querySelector('input[type="checkbox"]').checked = false;
                const qtyInput = row.querySelector('.product-qty input');
                qtyInput.value = 0;
                row.querySelector('.product-total').textContent = '0.00‚Ç¨';
                row.classList.remove('selected');
            });

            // R√©appliquer les quantit√©s sauvegard√©es et ouvrir les cat√©gories concern√©es
            (bon.produits || []).forEach(p => {
                // Convertir l'index en string pour la correspondance avec data-index
                const indexStr = String(p.index);
                const row = document.querySelector(`.product-row[data-index="${indexStr}"]`);
                if (row) {
                    const qtyInput = row.querySelector('.product-qty input');
                    // Utiliser quantite au lieu de qty (coh√©rence avec saveBonTech)
                    const quantite = parseFloat(p.quantite || p.qty || 0);
                    qtyInput.value = quantite;
                    row.querySelector('input[type="checkbox"]').checked = quantite > 0;
                    row.classList.toggle('selected', quantite > 0);
                    updateRowTotal(qtyInput);

                    // Ouvrir la cat√©gorie pour que l'admin voie le produit install√©
                    const categoryContent = row.closest('.category-content');
                    if (categoryContent && categoryContent.classList.contains('hidden')) {
                        categoryContent.classList.remove('hidden');
                        const header = categoryContent.previousElementSibling;
                        if (header && header.classList.contains('collapsed')) {
                            header.classList.remove('collapsed');
                        }
                    }
                } else {
                    console.warn('Produit non trouv√© avec index:', p.index, p.nom);
                }
            });

            // Charger les totaux sauvegard√©s si disponibles, sinon recalculer
            if (bon.subtotalProduits) {
                document.getElementById('subtotalProduits').textContent = bon.subtotalProduits;
            }
            if (bon.subtotalMO) {
                document.getElementById('subtotalMO').textContent = bon.subtotalMO;
            }
            if (bon.subtotalDepl) {
                document.getElementById('subtotalDepl').textContent = bon.subtotalDepl;
            }
            if (bon.totalHT) {
                document.getElementById('totalHT').textContent = bon.totalHT;
            }
            if (bon.totalTVA) {
                document.getElementById('totalTVA').textContent = bon.totalTVA;
            }
            if (bon.totalTTC) {
                document.getElementById('totalTTC').textContent = bon.totalTTC;
            }
            
            // Recalculer les totaux MO / d√©placement (pour mettre √† jour les champs)
            updateMO();
            updateDepl();
            // Recalculer les totaux finaux (pour s'assurer que tout est √† jour)
            calculateTotals();

            // Afficher les photos (thumbnails cliquables)
            const photosContainer = document.getElementById('photosAdmin');
            console.log('=== D√âBOGAGE PHOTOS ===');
            console.log('Conteneur photos trouv√©:', photosContainer);
            console.log('Photos du bon:', bon.photos);
            console.log('Type:', typeof bon.photos);
            console.log('Est tableau?', Array.isArray(bon.photos));
            console.log('Longueur:', bon.photos ? bon.photos.length : 0);
            
            if (photosContainer) {
                let html = '';
                
                if (bon.photos && Array.isArray(bon.photos) && bon.photos.length > 0) {
                    console.log('Affichage de', bon.photos.length, 'photos');
                    bon.photos.forEach(function(url, index) {
                        console.log("Photo " + index + ":", url);
                        console.log("URL valide (commence par http)?", url && url.startsWith('http'));
                        
                        if (url && typeof url === 'string' && url.trim() !== '' && url.startsWith('http')) {
                            const cleanUrl = url.trim();
                            html += '<img src="' + cleanUrl + '" alt="Photo ' + (index + 1) + '" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);margin:4px;cursor:pointer;" onclick="openPhotoLightbox(\'' + cleanUrl.replace(/'/g, "\\'") + '\')" onerror="console.error(\'Erreur chargement photo:\', this.src); this.style.display=\'none\'; this.nextElementSibling && (this.nextElementSibling.style.display=\'inline\');" onload="console.log(\'Photo charg√©e:\', this.src)" />';
                            html += '<span style="display:none;color:red;font-size:0.7rem;">Erreur</span>';
                        } else {
                            console.warn('Photo invalide √† l\'index', index, ':', url);
                        }
                    });
                    
                    if (html === '') {
                        html = '<p style="color:#718096;">Aucune photo valide</p>';
                    }
                } else {
                    console.log('Aucune photo ou tableau vide');
                    html = '<p style="color:#718096;">Aucune photo</p>';
                }
                
                photosContainer.innerHTML = html;
                console.log('HTML photos inject√©:', html.substring(0, 100) + '...');
            } else {
                console.error('ERREUR CRITIQUE: Conteneur photosAdmin introuvable dans le DOM !');
            }

            // Charger et afficher les signatures
            if (bon.signatures) {
                const sigTech = bon.signatures.technicien;
                const sigClient = bon.signatures.client;
                
                if (sigTech) {
                    const canvasTech = document.getElementById('signatureTech');
                    if (canvasTech) {
                        const ctx = canvasTech.getContext('2d');
                        const img = new Image();
                        img.onload = function() {
                            ctx.clearRect(0, 0, canvasTech.width, canvasTech.height);
                            ctx.drawImage(img, 0, 0, canvasTech.width, canvasTech.height);
                        };
                        img.src = sigTech;
                    }
                }
                
                if (sigClient) {
                    const canvasClient = document.getElementById('signatureClient');
                    if (canvasClient) {
                        const ctx = canvasClient.getContext('2d');
                        const img = new Image();
                        img.onload = function() {
                            ctx.clearRect(0, 0, canvasClient.width, canvasClient.height);
                            ctx.drawImage(img, 0, 0, canvasClient.width, canvasClient.height);
                        };
                        img.src = sigClient;
                    }
                }
            }
            
            // D√©sactiver les champs et boutons si le bon est valid√©
            if (estValide) {
                // D√©sactiver tous les champs de saisie
                const inputs = document.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.id !== 'bonNumber') { // Garder le num√©ro visible mais non modifiable
                        input.disabled = true;
                        input.style.backgroundColor = '#f0f0f0';
                        input.style.cursor = 'not-allowed';
                    }
                });
                
                // D√©sactiver les boutons d'action (sauf Envoyer en Comptabilit√© qui n'a plus de sens)
                const btnSave = document.querySelector('button[onclick="saveBon()"]');
                const btnEnvoyer = document.querySelector('button[onclick="envoyerCompta()"]');
                if (btnSave) {
                    btnSave.disabled = true;
                    btnSave.style.opacity = '0.5';
                    btnSave.style.cursor = 'not-allowed';
                    btnSave.title = 'Ce bon est valid√© et ne peut plus √™tre modifi√©';
                }
                if (btnEnvoyer) {
                    btnEnvoyer.disabled = true;
                    btnEnvoyer.style.opacity = '0.5';
                    btnEnvoyer.style.cursor = 'not-allowed';
                    btnEnvoyer.title = 'Ce bon a d√©j√† √©t√© envoy√© √† la comptabilit√©';
                }
                
                // D√©sactiver les signatures
                const canvases = document.querySelectorAll('canvas');
                canvases.forEach(canvas => {
                    canvas.style.pointerEvents = 'none';
                    canvas.style.opacity = '0.6';
                });
            } else {
                // R√©activer tous les champs si le bon n'est pas valid√©
                const inputs = document.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    input.disabled = false;
                    input.style.backgroundColor = '';
                    input.style.cursor = '';
                });
                
                const btnSave = document.querySelector('button[onclick="saveBon()"]');
                const btnEnvoyer = document.querySelector('button[onclick="envoyerCompta()"]');
                if (btnSave) {
                    btnSave.disabled = false;
                    btnSave.style.opacity = '';
                    btnSave.style.cursor = '';
                    btnSave.title = '';
                }
                if (btnEnvoyer) {
                    btnEnvoyer.disabled = false;
                    btnEnvoyer.style.opacity = '';
                    btnEnvoyer.style.cursor = '';
                    btnEnvoyer.title = '';
                }
                
                const canvases = document.querySelectorAll('canvas');
                canvases.forEach(canvas => {
                    canvas.style.pointerEvents = '';
                    canvas.style.opacity = '';
                });
            }
        } catch (e) {
            console.error(e);
            alert("Erreur lors du chargement du bon depuis Firestore.");
        }
        }

        // Fonction pour envoyer l'email √† la comptabilit√© via EmailJS
        async function envoyerEmailCompta(bon) {
            try {
                const emailDest = bon.email || EMAILJS_CONFIG.emailDest;
                const serviceID = EMAILJS_CONFIG.serviceID;
                const templateID = EMAILJS_CONFIG.templateID;
                
                console.log("=== CONFIGURATION EMAILJS ===");
                console.log("Email destination:", emailDest);
                console.log("Service ID utilis√©:", serviceID);
                console.log("Template ID utilis√©:", templateID);
                console.log("Public Key:", EMAILJS_CONFIG.publicKey);
                console.log('Donn√©es du bon:', bon);
                
                // V√©rification pr√©alable des IDs
                if (!serviceID) {
                    console.warn("‚ö†Ô∏è ATTENTION: Service ID non configur√©. V√©rifiez votre configuration!");
                }
                if (!templateID || templateID === "template_qsnhl5e") {
                    console.warn("‚ö†Ô∏è ATTENTION: Template ID par d√©faut d√©tect√©. V√©rifiez votre configuration!");
                }
                
                const result = await emailjs.send(serviceID, templateID, {
                    email: emailDest,
                    numero: bon.numero || '',
                    date: bon.date || '',
                    client: bon.client || '',
                    adresse: bon.adresse || bon.address || '',
                    technicien: bon.technicien || '',
                    description: bon.description || '',
                    statut: bon.statut || 'Valid√©',
                    heure_arrivee: bon.heure_arrivee || '',
                    heure_depart: bon.heure_depart || '',
                    totalHT: bon.totalHT || '',
                    totalTVA: bon.totalTVA || '',
                    totalTTC: bon.totalTTC || '',
                    // Variables suppl√©mentaires pour le template
                    produits: bon.produits || 'Aucun',
                    main_oeuvre: bon.mainOeuvre || '',
                    deplacement: bon.deplacement || '',
                    subtotal_produits: bon.subtotalProduits || '0.00‚Ç¨',
                    total_ht: bon.totalHT || '',
                    total_tva: bon.totalTVA || '',
                    total_ttc: bon.totalTTC || '',
                    photos: bon.photos || 'Aucune photo',
                    message: bon.corpsComplet || ''
                });
                console.log('Email envoy√© avec succ√®s:', result);
                alert("‚úì Email envoy√© √† la comptabilit√© avec succ√®s !");
                return true;
            } catch (error) {
                console.error("Erreur envoi email EmailJS:", error);
                console.error("D√©tails de l'erreur:", {
                    status: error.status,
                    text: error.text,
                    message: error.message
                });
                
                let errorMessage = "‚ùå Erreur lors de l'envoi de l'email.\n\n";
                if (error.text && (error.text.includes("service ID not found") || error.text.includes("Service ID not found"))) {
                    errorMessage += "‚ö†Ô∏è LE SERVICE ID EMAILJS N'EST PAS TROUV√â.\n\n";
                    errorMessage += "üìã CONFIGURATION ACTUELLE:\n";
                    errorMessage += `   Service ID: ${EMAILJS_CONFIG.serviceID}\n`;
                    errorMessage += `   Template ID: ${EMAILJS_CONFIG.templateID}\n`;
                    errorMessage += `   Public Key: ${EMAILJS_CONFIG.publicKey}\n\n`;
                    errorMessage += "üîß POUR CORRIGER:\n";
                    errorMessage += "1. Allez sur: https://dashboard.emailjs.com/admin\n";
                    errorMessage += "2. Dans 'Email Services', copiez votre Service ID r√©el\n";
                    errorMessage += "3. Dans 'Email Templates', copiez votre Template ID r√©el\n";
                    errorMessage += "4. Modifiez la section EMAILJS_CONFIG dans admin.html (ligne ~498)\n";
                    errorMessage += "5. Remplacez serviceID et templateID par vos IDs r√©els\n\n";
                    errorMessage += "üí° Les IDs doivent √™tre au format:\n";
                    errorMessage += "   - Service: service_xxxxxxx\n";
                    errorMessage += "   - Template: template_xxxxxxx";
                } else if (error.text && error.text.includes("template")) {
                    errorMessage += "‚ö†Ô∏è ERREUR TEMPLATE ID.\n\n";
                    errorMessage += `Template ID utilis√©: ${EMAILJS_CONFIG.templateID}\n\n`;
                    errorMessage += "V√©rifiez votre Template ID dans le dashboard EmailJS.";
                } else {
                    errorMessage += "D√©tails de l'erreur:\n";
                    errorMessage += error.text || error.message || error;
                }
                
                alert(errorMessage);
                return false;
            }
        }

        // Fonction pour g√©n√©rer le PDF du bon d'intervention (pour admin.html)
        async function genererPDFBon(paymentLinkParam = null) {
            if (typeof window.jspdf === 'undefined') {
                throw new Error("jsPDF n'est pas charg√©. Veuillez recharger la page.");
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            console.log('jsPDF initialis√©, d√©but g√©n√©ration PDF...');
            
            const infoCEP = {
                nom: "CEP - √âlectricit√© G√©n√©rale, Installation, D√©pannage",
                adresse: "6, rue de Metz, 94240 L'Ha√ø-les-Roses",
                tel: "T√©l. 01 56 04 19 96",
                email: "contact@cep75.fr",
                web: "www.cep75.fr"
            };
            
            const numeroBon = document.getElementById('bonNumber').textContent;
            const date = document.getElementById('interventionDate').value || '';
            const client = document.getElementById('clientName').value || '';
            const clientAddress = document.getElementById('clientAddress').value || '';
            const technicien = document.getElementById('technicien').value || '';
            const heureArrivee = document.getElementById('heureArrivee').value || '';
            const heureDepart = document.getElementById('heureDepart').value || '';
            const description = document.getElementById('description').value || '';
            const totalTTC = document.getElementById('totalTTC').textContent || '0.00‚Ç¨';
            
            const produits = [];
            document.querySelectorAll('.product-row').forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const qtyInput = row.querySelector('.product-qty input');
                const qty = parseFloat(qtyInput.value) || 0;
                if (checkbox && checkbox.checked && qty > 0) {
                    const name = row.querySelector('.product-name')?.textContent || '';
                    const ref = row.querySelector('.product-ref')?.textContent || '';
                    const price = parseFloat(qtyInput.dataset.price || '0');
                    produits.push({ nom: name, reference: ref, quantite: qty, prix: price });
                }
            });
            
            const signatureTech = document.getElementById('signatureTech');
            const signatureClient = document.getElementById('signatureClient');
            let sigTechData = null;
            let sigClientData = null;
            try {
                if (signatureTech && signatureTech.toDataURL) {
                    sigTechData = signatureTech.toDataURL('image/png');
                }
                if (signatureClient && signatureClient.toDataURL) {
                    sigClientData = signatureClient.toDataURL('image/png');
                }
            } catch(e) {
                console.error('Erreur r√©cup√©ration signatures:', e);
            }
            
            let yPos = 20;
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(infoCEP.nom, 105, yPos, { align: 'center' });
            yPos += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(infoCEP.adresse, 105, yPos, { align: 'center' });
            yPos += 5;
            doc.text(infoCEP.tel, 105, yPos, { align: 'center' });
            yPos += 5;
            doc.text(infoCEP.email + ' / ' + infoCEP.web, 105, yPos, { align: 'center' });
            yPos += 10;
            
            doc.setLineWidth(0.5);
            doc.line(20, yPos, 190, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('FACTURE PROVISOIRE', 105, yPos, { align: 'center' });
            yPos += 6;
            doc.setFontSize(12);
            doc.text('Bon d\'intervention N¬∞ ' + numeroBon, 105, yPos, { align: 'center' });
            yPos += 10;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('CLIENT :', 20, yPos);
            yPos += 6;
            doc.setFont(undefined, 'normal');
            doc.text(client, 20, yPos);
            yPos += 5;
            if (clientAddress) {
                doc.text(clientAddress, 20, yPos);
                yPos += 5;
            }
            yPos += 3;
            
            doc.setFont(undefined, 'bold');
            doc.text('INTERVENTION :', 20, yPos);
            yPos += 6;
            doc.setFont(undefined, 'normal');
            doc.text('Date : ' + date, 20, yPos);
            yPos += 5;
            doc.text('Intervenant : ' + technicien, 20, yPos);
            yPos += 5;
            if (heureArrivee) doc.text('Heure d\'arriv√©e : ' + heureArrivee, 20, yPos);
            if (heureDepart) {
                if (heureArrivee) yPos += 5;
                doc.text('Heure de d√©part : ' + heureDepart, 20, yPos);
            }
            yPos += 8;
            
            if (description) {
                doc.setFont(undefined, 'bold');
                doc.text('DESCRIPTION :', 20, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                const descLines = doc.splitTextToSize(description, 170);
                doc.text(descLines, 20, yPos);
                yPos += descLines.length * 5 + 3;
            }
            
            if (photosAdmin && photosAdmin.length > 0) {
                if (yPos > 200) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('PHOTOS DE L\'INTERVENTION :', 20, yPos);
                yPos += 8;
                
                const photoWidth = 80;
                const photoHeight = 60;
                const photosPerRow = 2;
                const spacing = 10;
                
                for (let i = 0; i < photosAdmin.length; i++) {
                    const photoUrl = photosAdmin[i];
                    if (!photoUrl) continue;
                    
                    let imgData;
                    try {
                        const img = await new Promise((resolve, reject) => {
                            const imgElement = new Image();
                            imgElement.crossOrigin = 'anonymous';
                            imgElement.onload = () => resolve(imgElement);
                            imgElement.onerror = reject;
                            imgElement.src = photoUrl;
                        });
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        imgData = canvas.toDataURL('image/jpeg', 0.8);
                    } catch (err) {
                        console.error(`Erreur conversion photo ${i + 1}:`, err);
                        continue;
                    }
                    
                    if (yPos + photoHeight > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    const col = i % photosPerRow;
                    const xPos = 20 + col * (photoWidth + spacing);
                    
                    try {
                        doc.addImage(imgData, 'JPEG', xPos, yPos, photoWidth, photoHeight);
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'normal');
                        doc.text(`Photo ${i + 1}`, xPos + photoWidth / 2, yPos + photoHeight + 4, { align: 'center' });
                    } catch (photoError) {
                        console.error(`Erreur ajout photo ${i + 1}:`, photoError);
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        doc.text(`Photo ${i + 1} (erreur)`, xPos, yPos + 10);
                    }
                    
                    if ((i + 1) % photosPerRow === 0) {
                        yPos += photoHeight + 12;
                    }
                }
                
                if (photosAdmin.length % photosPerRow !== 0) {
                    yPos += photoHeight + 12;
                }
                yPos += 5;
            }
            
            if (produits.length > 0) {
                doc.setFont(undefined, 'bold');
                doc.text('MAT√âRIEL POS√â :', 20, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                
                produits.forEach(p => {
                    const ligne = `${p.nom}${p.reference ? ' (Ref: ' + p.reference + ')' : ''} - Qt√©: ${p.quantite}${p.prix > 0 ? ' - Prix unitaire: ' + p.prix.toFixed(2) + '‚Ç¨' : ''}`;
                    const lignes = doc.splitTextToSize(ligne, 170);
                    doc.text(lignes, 20, yPos);
                    yPos += lignes.length * 4;
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                });
                yPos += 3;
            }
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('TOTAL TTC : ' + totalTTC, 20, yPos);
            yPos += 10;
            
            if (sigTechData || sigClientData) {
                const sigWidth = 70;
                const sigHeight = 30;
                
                if (sigTechData) {
                    doc.setFontSize(9);
                    doc.text('Signature Intervenant :', 20, yPos);
                    yPos += 5;
                    try {
                        doc.addImage(sigTechData, 'PNG', 20, yPos, sigWidth, sigHeight);
                    } catch(e) {
                        console.error('Erreur ajout signature technicien:', e);
                    }
                }
                
                if (sigClientData) {
                    if (sigTechData) {
                        yPos = yPos - 5;
                    }
                    doc.setFontSize(9);
                    doc.text('Signature Client :', 120, yPos - 5);
                    if (!sigTechData) yPos += 5;
                    try {
                        doc.addImage(sigClientData, 'PNG', 120, yPos, sigWidth, sigHeight);
                    } catch(e) {
                        console.error('Erreur ajout signature client:', e);
                    }
                }
            }
            
            // Section Paiement rapide (uniquement si le lien de paiement existe)
            // Utiliser le lien pass√© en param√®tre ou le r√©cup√©rer depuis Firebase
            let paymentLink = paymentLinkParam;
            if (!paymentLink) {
                try {
                    if (currentBonId) {
                        const bonDoc = await db.collection('bons').doc(currentBonId).get();
                        if (bonDoc.exists && bonDoc.data().paymentLink) {
                            paymentLink = bonDoc.data().paymentLink;
                        }
                    }
                } catch (e) {
                    console.warn('Erreur r√©cup√©ration lien paiement:', e);
                }
            }
            
            // Si toujours pas de lien de paiement, le g√©n√©rer
            if (!paymentLink) {
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                paymentLink = isLocal 
                    ? `${window.location.origin}/BI-${numeroBon}`
                    : `https://pay.elecho-system.com/BI-${numeroBon}`;
            }
            
            if (paymentLink) {
                yPos += 20;
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('PAIEMENT RAPIDE', 105, yPos, { align: 'center' });
                yPos += 8;
                
                // Conditions de paiement
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text('Conditions de paiement :', 20, yPos);
                yPos += 5;
                doc.setFontSize(8);
                doc.text('‚Ä¢ Paiement sous 3 jours : r√©duction de 5%', 20, yPos);
                yPos += 4;
                doc.text('‚Ä¢ Paiement sous 30 jours : montant normal', 20, yPos);
                yPos += 4;
                doc.text('‚Ä¢ Au-del√† de 30 jours : p√©nalit√©s de retard', 20, yPos);
                yPos += 8;
                
                // G√©n√©rer le QR code
                try {
                    if (typeof QRCode !== 'undefined') {
                        const qrDiv = document.createElement('div');
                        qrDiv.id = 'temp-qr-div-' + Date.now();
                        qrDiv.style.position = 'absolute';
                        qrDiv.style.left = '-9999px';
                        qrDiv.style.top = '-9999px';
                        document.body.appendChild(qrDiv);
                        
                        const qr = new QRCode(qrDiv, {
                            text: paymentLink,
                            width: 120,
                            height: 120,
                            colorDark: '#000000',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel.M
                        });
                        
                        await new Promise((resolve) => {
                            const checkQR = () => {
                                const canvas = qrDiv.querySelector('canvas');
                                const img = qrDiv.querySelector('img');
                                
                                if (canvas) {
                                    const qrData = canvas.toDataURL('image/png');
                                    doc.addImage(qrData, 'PNG', 105 - 25, yPos, 50, 50);
                                    qrDiv.remove();
                                    resolve();
                                } else if (img && img.complete) {
                                    const qrData = img.src;
                                    doc.addImage(qrData, 'PNG', 105 - 25, yPos, 50, 50);
                                    qrDiv.remove();
                                    resolve();
                                } else {
                                    setTimeout(checkQR, 100);
                                }
                            };
                            checkQR();
                        });
                    }
                } catch (qrError) {
                    console.error('Erreur g√©n√©ration QR code:', qrError);
                }
                
                yPos += 45;
                
                // Lien cliquable (texte)
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 255);
                doc.text('Lien de paiement :', 20, yPos);
                yPos += 5;
                doc.setFontSize(8);
                const linkLines = doc.splitTextToSize(paymentLink, 170);
                doc.text(linkLines, 20, yPos);
                doc.setTextColor(0, 0, 0);
            }
            
            const pdfBlob = doc.output('blob');
            return pdfBlob;
        }

        // Fonction pour envoyer l'email avec PDF en pi√®ce jointe via SMTP OVH
        async function envoyerEmailAvecPDFSMTP(data) {
            try {
                console.log('=== ENVOI EMAIL AVEC PDF VIA SMTP OVH ===');
                console.log('Email destination:', data.email);
                console.log('URL API:', SMTP_API_URL);
                
                if (!SMTP_API_URL || SMTP_API_URL.includes('votre-projet')) {
                    throw new Error('SMTP_API_URL non configur√©e. Veuillez configurer l\'URL de votre API Vercel dans admin.html');
                }
                
                console.log('Envoi de la requ√™te √† l\'API Vercel...');
                const response = await fetch(SMTP_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: data.email,
                        subject: data.subject,
                        pdfBase64: data.pdfBase64,
                        pdfFileName: data.pdfFileName,
                        bonData: data.bonData
                    })
                });
                
                console.log('R√©ponse re√ßue, status:', response.status, response.statusText);
                
                // V√©rifier le type de contenu avant de parser
                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);
                
                let result;
                try {
                    const text = await response.text();
                    console.log('R√©ponse brute (premiers 500 caract√®res):', text.substring(0, 500));
                    
                    if (contentType && contentType.includes('application/json')) {
                        result = JSON.parse(text);
                    } else {
                        // Si ce n'est pas du JSON, essayer quand m√™me de parser
                        try {
                            result = JSON.parse(text);
                        } catch (e) {
                            throw new Error(`R√©ponse non-JSON re√ßue: ${text.substring(0, 200)}`);
                        }
                    }
                } catch (parseError) {
                    console.error('‚ùå Erreur parsing JSON:', parseError);
                    throw new Error(`Erreur lors de la lecture de la r√©ponse de l'API: ${parseError.message}`);
                }
                
                console.log('R√©ponse API Vercel pars√©e:', result);
                console.log('Status HTTP:', response.status);
                
                if (!response.ok) {
                    console.error('‚ùå Erreur API (status non-OK):', result);
                    throw new Error(result.error || result.message || `Erreur HTTP ${response.status}: ${response.statusText}`);
                }
                
                console.log('‚úÖ Email envoy√© avec succ√®s via SMTP OVH:', result);
                console.log('Message ID:', result.messageId);
                alert("‚úì Email envoy√© √† la comptabilit√© avec PDF en pi√®ce jointe !\n\nMessage ID: " + (result.messageId || 'N/A'));
                return true;
                
            } catch (error) {
                console.error("Erreur envoi email SMTP OVH:", error);
                console.error("D√©tails de l'erreur:", {
                    message: error.message,
                    stack: error.stack
                });
                
                let errorMessage = "‚ùå Erreur lors de l'envoi de l'email.\n\n";
                if (error.message.includes('SMTP_API_URL')) {
                    errorMessage += "‚ö†Ô∏è CONFIGURATION REQUISE:\n\n";
                    errorMessage += "1. D√©ployez la fonction serverless sur Vercel\n";
                    errorMessage += "2. Configurez OVH_SMTP_PASSWORD dans Vercel\n";
                    errorMessage += "3. Mettez √† jour SMTP_API_URL dans admin.html\n";
                    errorMessage += "4. Voir INSTRUCTIONS_SMTP_OVH.md pour plus de d√©tails";
                } else {
                    errorMessage += "D√©tails: " + (error.message || error);
                }
                
                alert(errorMessage);
                throw error;
            }
        }

        async function supprimerBon(id, statut) {
            // V√©rifier le statut (peut √™tre pass√© en param√®tre ou r√©cup√©r√© depuis Firestore)
            let bonStatut = statut;
            if (!bonStatut) {
                try {
                    const doc = await db.collection('bons').doc(id).get();
                    if (doc.exists) {
                        bonStatut = doc.data().statut || 'en_attente';
                    }
                } catch (e) {
                    console.error('Erreur r√©cup√©ration statut:', e);
                }
            }
            
            // Si le bon est valid√©, demander le code admin
            if (bonStatut === 'valid√©' || bonStatut === 'valide') {
                const code = prompt("Ce bon a √©t√© envoy√© √† la compta. Entrez le code admin pour supprimer :");
                if (code !== 'CEP2024') {
                    alert("Code incorrect. Suppression annul√©e.");
                    return;
                }
            }
            
            // Confirmation de suppression
            if (!confirm("√ätes-vous s√ªr de vouloir supprimer ce bon ?")) {
                return;
            }
            
            try {
                await db.collection('bons').doc(id).delete();
                if (currentBonId === id) currentBonId = null;
                alert("Bon supprim√©.");
                await renderHistorique();
            } catch (e) {
                console.error(e);
                alert("Erreur lors de la suppression du bon.");
            }
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.bon-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateSelectionCount();
        }

        function updateSelectionCount() {
            const checkboxes = document.querySelectorAll('.bon-checkbox:checked');
            const count = checkboxes.length;
            const btnSupprimer = document.getElementById('btnSupprimerSelection');
            const nbSelectionnes = document.getElementById('nbSelectionnes');
            
            if (nbSelectionnes) {
                nbSelectionnes.textContent = count;
            }
            
            if (btnSupprimer) {
                if (count > 0) {
                    btnSupprimer.style.display = 'inline-block';
                    btnSupprimer.disabled = false;
                } else {
                    btnSupprimer.style.display = 'none';
                    btnSupprimer.disabled = true;
                }
            }
            
            // Mettre √† jour la case "Tout s√©lectionner"
            const selectAllCheckbox = document.getElementById('selectAll');
            const allCheckboxes = document.querySelectorAll('.bon-checkbox');
            if (selectAllCheckbox && allCheckboxes.length > 0) {
                selectAllCheckbox.checked = count === allCheckboxes.length && count > 0;
            }
        }

        async function supprimerBonsSelectionnes() {
            const checkboxes = document.querySelectorAll('.bon-checkbox:checked');
            if (checkboxes.length === 0) {
                alert("Aucun bon s√©lectionn√©.");
                return;
            }
            
            // R√©cup√©rer les IDs et statuts des bons s√©lectionn√©s
            const bonsASupprimer = [];
            let aDesBonsValides = false;
            
            checkboxes.forEach(checkbox => {
                const id = checkbox.getAttribute('data-bon-id');
                const statut = checkbox.getAttribute('data-statut');
                const estValide = statut === 'valid√©' || statut === 'valide';
                if (estValide) aDesBonsValides = true;
                bonsASupprimer.push({ id, statut, estValide });
            });
            
            // Si des bons valid√©s sont s√©lectionn√©s, demander le code admin
            if (aDesBonsValides) {
                const code = prompt(`${bonsASupprimer.length} bon(s) s√©lectionn√©(s), dont certains envoy√©s √† la compta.\nEntrez le code admin pour supprimer :`);
                if (code !== 'CEP2024') {
                    alert("Code incorrect. Suppression annul√©e.");
                    return;
                }
            }
            
            // Confirmation de suppression
            const message = `√ätes-vous s√ªr de vouloir supprimer ${bonsASupprimer.length} bon(s) ?\n\nCette action est irr√©versible.`;
            if (!confirm(message)) {
                return;
            }
            
            // Supprimer les bons un par un
            let succes = 0;
            let erreurs = 0;
            
            for (const bon of bonsASupprimer) {
                try {
                    await db.collection('bons').doc(bon.id).delete();
                    if (currentBonId === bon.id) currentBonId = null;
                    succes++;
                } catch (e) {
                    console.error(`Erreur suppression bon ${bon.id}:`, e);
                    erreurs++;
                }
            }
            
            // Afficher le r√©sultat
            if (erreurs === 0) {
                alert(`${succes} bon(s) supprim√©(s) avec succ√®s.`);
            } else {
                alert(`${succes} bon(s) supprim√©(s), ${erreurs} erreur(s).`);
            }
            
            // Recharger l'historique
            await renderHistorique();
        }

        function openPhotoLightbox(url) {
            console.log('Ouverture lightbox pour:', url);
            const overlay = document.getElementById('photoLightbox');
            const img = document.getElementById('photoLightboxImg');
            if (!overlay) {
                console.error('Lightbox overlay introuvable !');
                return;
            }
            if (!img) {
                console.error('Image lightbox introuvable !');
                return;
            }
            img.src = url;
            img.onerror = function() {
                console.error('Erreur chargement image dans lightbox:', url);
                alert('Impossible de charger la photo.');
            };
            overlay.classList.add('show');
        }

        function closePhotoLightbox() {
            const overlay = document.getElementById('photoLightbox');
            if (!overlay) return;
            overlay.classList.remove('show');
        }

        async function removePhotoAdmin(index) {
            if (index < 0 || index >= photosAdmin.length) return;
            if (!currentBonId) return;
            
            try {
                const url = photosAdmin[index];
                // Supprimer de Firebase Storage
                if (url && storage && storage.refFromURL) {
                    try {
                        await storage.refFromURL(url).delete();
                    } catch (e) {
                        console.warn('Erreur suppression Storage (ignor√©e)', e);
                    }
                }
                
                // Retirer de la liste
                photosAdmin.splice(index, 1);
                
                // Mettre √† jour dans Firestore
                await db.collection('bons').doc(currentBonId).update({
                    photos: photosAdmin
                });
                
                // R√©afficher les photos
                const photosContainer = document.getElementById('photosAdmin');
                if (photosContainer) {
                    if (!photosAdmin.length) {
                        photosContainer.innerHTML = '<p style="color:var(--text-light); margin-top:4px;">Aucune photo pour ce bon.</p>';
                    } else {
                        photosContainer.innerHTML = photosAdmin.map((url, idx) =>
                            `<div class="photo-thumb-admin" data-index="${idx}">
                                <img src="${url}" alt="Photo intervention" onclick="openPhotoLightbox('${url.replace(/'/g, "\\'")}')" />
                                <button type="button" class="photo-remove-admin" onclick="removePhotoAdmin(${idx}); event.stopPropagation();">√ó</button>
                            </div>`
                        ).join("");
                    }
                }
            } catch (e) {
                console.error('Erreur suppression photo', e);
                alert("Erreur lors de la suppression de la photo.");
            }
        }

        // Exporter la liste des clients vers Excel (Admin uniquement)
        async function exporterClientsExcel() {
            try {
                // Charger tous les clients depuis Firestore (sans orderBy pour √©viter les probl√®mes d'index)
                const snapshot = await db.collection('clients').get();
                const clients = [];
                snapshot.forEach(doc => {
                    clients.push({ id: doc.id, ...doc.data() });
                });
                // Trier localement par nom
                clients.sort((a, b) => {
                    const nomA = (a.nom || '').toLowerCase();
                    const nomB = (b.nom || '').toLowerCase();
                    return nomA.localeCompare(nomB);
                });
                
                if (clients.length === 0) {
                    alert('Aucun client √† exporter.');
                    return;
                }

                // Pr√©parer les donn√©es pour Excel
                const data = clients.map(client => ({
                    'Nom / Soci√©t√©': client.nom || '',
                    'Email': client.email || '',
                    'T√©l√©phone': client.telephone || '',
                    'Adresse': client.adresse || ''
                }));

                // Cr√©er un nouveau workbook
                const wb = XLSX.utils.book_new();
                
                // Cr√©er une feuille de calcul √† partir des donn√©es
                const ws = XLSX.utils.json_to_sheet(data);
                
                // Ajuster la largeur des colonnes
                const colWidths = [
                    { wch: 30 }, // Nom
                    { wch: 30 }, // Email
                    { wch: 20 }, // T√©l√©phone
                    { wch: 40 }  // Adresse
                ];
                ws['!cols'] = colWidths;
                
                // Ajouter la feuille au workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Clients');
                
                // G√©n√©rer le nom du fichier avec la date
                const date = new Date();
                const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
                const fileName = `clients_${dateStr}.xlsx`;
                
                // T√©l√©charger le fichier
                XLSX.writeFile(wb, fileName);
                
                alert(`‚úÖ ${clients.length} client(s) export√©(s) avec succ√®s !\n\nFichier : ${fileName}`);
            } catch (error) {
                console.error('Erreur export Excel:', error);
                alert('Erreur lors de l\'export : ' + error.message);
            }
        }

        // Importer des clients depuis un fichier Excel (Admin uniquement)
        async function importerClientsExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            // V√©rifier le type de fichier
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                alert('Veuillez s√©lectionner un fichier Excel (.xlsx ou .xls)');
                return;
            }

            try {
                // Lire le fichier
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Prendre la premi√®re feuille
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convertir en JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        if (jsonData.length === 0) {
                            alert('Le fichier Excel est vide ou ne contient pas de donn√©es');
                            return;
                        }

                        console.log('Donn√©es Excel lues:', jsonData);

                        // Demander confirmation
                        const confirmMsg = `Vous allez importer ${jsonData.length} client(s).\n\n` +
                            `Les clients avec le m√™me email seront mis √† jour.\n\n` +
                            `Continuer ?`;
                        
                        if (!confirm(confirmMsg)) {
                            event.target.value = '';
                            return;
                        }

                        // Importer les clients
                        let succes = 0;
                        let erreurs = 0;
                        let misAJour = 0;
                        let crees = 0;

                        for (const row of jsonData) {
                            try {
                                // Normaliser les noms de colonnes (insensible √† la casse)
                                const nom = (row.Nom || row.nom || row.NOM || row['Nom / Soci√©t√©'] || row['Nom/Soci√©t√©'] || '').trim();
                                const email = (row.Email || row.email || row.EMAIL || row['E-mail'] || row['E-Mail'] || '').trim();
                                const telephone = (row.T√©l√©phone || row.telephone || row.TELEPHONE || row.Tel || row.tel || row['T√©l√©phone'] || '').trim();
                                const adresse = (row.Adresse || row.adresse || row.ADRESSE || row['Adresse compl√®te'] || row['Adresse'] || '').trim();

                                if (!nom || !email) {
                                    console.warn('Ligne ignor√©e (nom ou email manquant):', row);
                                    erreurs++;
                                    continue;
                                }

                                // V√©rifier si le client existe d√©j√† (par email)
                                const existing = await db.collection('clients').where('email', '==', email).get();
                                
                                if (!existing.empty) {
                                    // Mettre √† jour
                                    const clientId = existing.docs[0].id;
                                    await db.collection('clients').doc(clientId).update({
                                        nom: nom,
                                        telephone: telephone,
                                        adresse: adresse,
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    misAJour++;
                                } else {
                                    // Cr√©er
                                    await db.collection('clients').add({
                                        nom: nom,
                                        email: email,
                                        telephone: telephone,
                                        adresse: adresse,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    crees++;
                                }
                                succes++;
                            } catch (error) {
                                console.error('Erreur import ligne:', row, error);
                                erreurs++;
                            }
                        }

                        // Afficher le r√©sultat
                        let message = `‚úÖ Import termin√© !\n\n`;
                        message += `‚úì ${succes} client(s) trait√©(s)\n`;
                        message += `  - ${crees} cr√©√©(s)\n`;
                        message += `  - ${misAJour} mis √† jour\n`;
                        if (erreurs > 0) {
                            message += `\n‚ö†Ô∏è ${erreurs} erreur(s)`;
                        }
                        alert(message);

                        // R√©initialiser l'input
                        event.target.value = '';
                    } catch (error) {
                        console.error('Erreur lecture Excel:', error);
                        alert('Erreur lors de la lecture du fichier Excel: ' + error.message);
                        event.target.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Erreur import Excel:', error);
                alert('Erreur lors de l\'import: ' + error.message);
                event.target.value = '';
            }
        }
    </script>
</body>
</html>


