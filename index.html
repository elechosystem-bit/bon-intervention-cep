<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bon d'Intervention - CEP</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bon CEP">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #f6ad55;
            --accent-dark: #dd6b20;
            --bg: #f7fafc;
            --card: #ffffff;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
            --success: #48bb78;
            --danger: #fc8181;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 30px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .logo-section h1 { font-size: 1.5rem; font-weight: 700; }
        .logo-section p { font-size: 0.9rem; opacity: 0.9; margin-top: 4px; }
        .bon-number { background: rgba(255,255,255,0.15); padding: 12px 20px; border-radius: 10px; text-align: right; display: flex; flex-direction: column; gap: 6px; align-items: flex-end; }
        .bon-number span { font-family: 'Space Mono', monospace; font-size: 1.3rem; font-weight: 700; }
        .bon-number p { font-size: 0.8rem; opacity: 0.8; }
        .form-body { background: var(--card); padding: 30px; border: 1px solid var(--border); border-top: none; }
        .section { margin-bottom: 30px; }
        .section-title { font-size: 1.1rem; font-weight: 600; color: var(--primary); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--accent); display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: ''; width: 4px; height: 20px; background: var(--accent); border-radius: 2px; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .input-group { display: flex; flex-direction: column; gap: 6px; position: relative; }
        .input-group label { font-size: 0.85rem; font-weight: 500; color: var(--text-light); margin-bottom: 6px; }
        .input-group input, .input-group textarea, .input-group select { padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 1rem; transition: all 0.2s ease; background: white; }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1); }
        
        /* Modal overlay */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; padding: 30px; border-radius: 16px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        
        /* Style pour le s√©lecteur de mat√©riel */
        .material-selector { background: #f0f7ff; border: 2px solid var(--primary); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .material-selector label { font-weight: 600; color: var(--primary); margin-bottom: 10px; display: block; }
        .material-selector-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .material-selector select { flex: 1; min-width: 200px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; background: white; }
        .material-selector input[type="number"] { width: 80px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; text-align: center; font-family: 'Space Mono', monospace; }
        .material-selector .btn-add { padding: 12px 20px; background: var(--success); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .material-selector .btn-add:hover { background: #38a169; transform: scale(1.05); }

        .category-section { margin-bottom: 20px; }
        .category-header { background: var(--primary); color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .category-header:hover { background: var(--primary-light); }
        .category-header .toggle-icon { transition: transform 0.3s; }
        .category-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        .category-content { border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px; overflow: hidden; }
        .category-content.hidden { display: none; }
        /* Version technicien : afficher les produits mais sans aucun prix (voir r√®gles ci-dessous) */
        .product-row { display: grid; grid-template-columns: 40px 1fr 80px; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .product-row:last-child { border-bottom: none; }
        .product-row:hover { background: #f8fafc; }
        .product-row.selected { background: #ebf8ff; }
        .product-row input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        .product-name { font-size: 0.85rem; }
        .product-ref { font-size: 0.7rem; color: var(--text-light); font-family: 'Space Mono', monospace; }
        .product-price { font-weight: 600; color: var(--primary); text-align: center; font-size: 0.85rem; display: none !important; }
        .product-qty input { width: 55px; padding: 5px; text-align: center; border: 2px solid var(--border); border-radius: 6px; font-family: 'Space Mono', monospace; }
        .product-total { font-weight: 700; color: var(--accent-dark); text-align: right; font-family: 'Space Mono', monospace; font-size: 0.9rem; display: none !important; }
        .service-row { display: grid; grid-template-columns: 1fr 120px 120px 120px; align-items: center; padding: 15px; background: #fffaf0; border: 2px solid var(--accent); border-radius: 10px; margin-bottom: 10px; gap: 10px; }
        /* Version technicien : ajuster la grille pour ne montrer que la dur√©e (pas de demi-heures ni total) */
        .service-row:has(#moDemiHeures[style*="display: none"]) {
            grid-template-columns: 1fr 150px;
        }
        /* Ajuster la grille pour D√©placement (nombre uniquement, pas de total visible) */
        .service-row:has(#deplNombre) {
            grid-template-columns: 1fr 150px;
        }
        .service-row label { font-weight: 600; }
        .service-row input { padding: 8px; border: 2px solid var(--border); border-radius: 6px; font-family: 'Space Mono', monospace; text-align: center; }
        /* Cacher les montants de main d'≈ìuvre / d√©placement pour les techniciens */
        #moTarif, #moDemiHeures, #moTotal, #deplTarif, #deplTotal, .service-row .product-total { display: none !important; }
        /* Cacher enti√®rement le r√©capitulatif des totaux pour la version technicien */
        .totals-section { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 25px; border-radius: 12px; margin-top: 20px; display: none !important; }
        .total-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 1rem; }
        .total-row.grand-total { font-size: 1.4rem; font-weight: 700; border-top: 2px solid rgba(255,255,255,0.3); padding-top: 15px; margin-top: 10px; }
        .total-row span:last-child { font-family: 'Space Mono', monospace; }

        /* Mode admin : r√©afficher les prix, totaux et listes produits */
        body.admin-mode .category-section { display: block !important; }
        body.admin-mode .product-row { grid-template-columns: 40px 1fr 90px 80px 90px; }
        body.admin-mode .product-price,
        body.admin-mode .product-total,
        body.admin-mode #moTarif,
        body.admin-mode #deplTarif,
        body.admin-mode .service-row .product-total,
        body.admin-mode .totals-section { display: block !important; }
        .signature-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px; }
        .signature-box { border: 2px dashed var(--border); border-radius: 12px; padding: 20px; text-align: center; }
        .signature-box h4 { font-size: 0.9rem; color: var(--text-light); margin-bottom: 15px; }
        .signature-canvas { width: 100%; height: 120px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: crosshair; touch-action: none; }
        .signature-actions { margin-top: 10px; }
        .btn-clear { padding: 6px 12px; font-size: 0.8rem; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; }
        .actions { display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap; }
        .btn { flex: 1; min-width: 200px; padding: 16px 30px; font-size: 1rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%); color: white; box-shadow: 0 4px 15px rgba(246, 173, 85, 0.4); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(246, 173, 85, 0.5); }
        .btn-secondary { background: var(--card); color: var(--primary); border: 2px solid var(--primary); }
        .btn-secondary:hover { background: var(--primary); color: white; }
        .btn-admin-toggle { padding: 4px 10px; font-size: 0.7rem; border-radius: 999px; border: 1px solid rgba(255,255,255,0.7); background: rgba(0,0,0,0.15); color: #fff; cursor: pointer; }
        .btn-admin-toggle:hover { background: rgba(0,0,0,0.3); }
        .notification-badge { position: absolute; top: -8px; right: -8px; background: transparent; color: #ef4444; font-size: 1rem; font-weight: bold; text-shadow: 0 0 3px rgba(255,255,255,0.8), 0 0 6px rgba(255,255,255,0.6); }
        .btn-email { padding: 8px 12px; font-size: 0.8rem; font-weight: 500; border-radius: 8px; border: 1px solid var(--primary); background: var(--card); color: var(--primary); cursor: pointer; align-self: flex-start; }
        .btn-email:hover { background: var(--primary); color: #fff; }
        .btn-photo { padding: 8px 12px; font-size: 0.8rem; font-weight: 500; border-radius: 8px; border: 1px dashed var(--primary); background: #ebf8ff; color: var(--primary); cursor: pointer; align-self: flex-start; display: inline-flex; align-items: center; gap: 6px; }
        .btn-photo:hover { background: #bee3f8; }
        .photos-preview, .photos-preview-admin { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .photos-preview img, .photos-preview-admin img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; }
        .photo-thumb, .photo-thumb-admin { position: relative; display: inline-block; }
        .photo-remove, .photo-remove-admin { position: absolute; top: -6px; right: -6px; background: rgba(0,0,0,0.7); color: #fff; border: none; border-radius: 999px; width: 18px; height: 18px; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .photo-lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .photo-lightbox.show { display: flex; }
        .photo-lightbox img { max-width: 90vw; max-height: 90vh; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .photo-lightbox-close { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.7); color: #fff; border: none; border-radius: 999px; width: 32px; height: 32px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .save-message { margin-top: 10px; font-size: 0.85rem; color: var(--success); display: none; }
        .save-message.show { display: block; }
        .footer { background: var(--primary); color: white; padding: 20px 30px; border-radius: 0 0 16px 16px; text-align: center; font-size: 0.85rem; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; animation: modalIn 0.3s ease; }
        @keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-icon { width: 80px; height: 80px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2.5rem; color: white; }
        .modal h3 { font-size: 1.5rem; margin-bottom: 10px; }
        .modal p { color: var(--text-light); margin-bottom: 20px; }
        @media (max-width: 768px) {
            .product-row { grid-template-columns: 30px 1fr 60px 70px; }
            .product-row .product-price { display: none; }
            .service-row { grid-template-columns: 1fr 1fr; }
            .signature-section { grid-template-columns: 1fr; }
            .header { flex-direction: column; text-align: center; }
            .bon-number { text-align: center; }
            .material-selector-row { flex-direction: column; }
            .material-selector select, .material-selector input[type="number"] { width: 100%; }
        }
        @media print {
            body { padding: 0; background: white; }
            .btn, .actions, .btn-clear, .material-selector { display: none !important; }
            .header, .footer, .totals-section { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
    <!-- EmailJS pour l'envoi automatique d'emails -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function() {
            emailjs.init("GXDaMfa8u-ZzmkvNn");
        })();
    </script>
    <!-- jsPDF pour g√©n√©rer les PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- QR Code pour g√©n√©rer les QR codes de paiement -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- SheetJS pour lire et √©crire les fichiers Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-section">
                <h1>‚ö° Compagnie d'√âlectricit√© Parisienne</h1>
                <p>Bon d'Intervention</p>
            </div>
            <div class="bon-number">
                <span id="bonNumber">CEP-2024-0001</span>
                <p id="currentDate"></p>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="position: relative; cursor: pointer;" onclick="toggleAdmin()" title="Notifications">
                        <span style="font-size: 1.5rem;">üîî</span>
                        <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                    </div>
                    <button type="button" class="btn-admin-toggle" onclick="toggleAdmin()">Mode admin</button>
                </div>
            </div>
        </div>

        <div class="form-body">
            <div class="section">
                <h3 class="section-title">Informations Client</h3>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: flex-end;">
                    <div class="input-group" style="flex: 1;">
                        <label>Rechercher un client existant</label>
                        <input type="text" id="clientSearch" placeholder="Tapez le nom du client..." autocomplete="off" oninput="rechercherClient(this.value)" style="position: relative;">
                        <div id="clientSearchResults" style="display: none; position: absolute; background: white; border: 2px solid var(--border); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; margin-top: 2px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px;"></div>
                    </div>
                </div>
                <div class="input-grid">
                    <div class="input-group"><label>Nom / Soci√©t√©</label><input type="text" id="clientName" placeholder="Nom du client"></div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="clientEmail" placeholder="email@exemple.fr">
                    </div>
                    <div class="input-group">
                        <label>Adresse compl√®te</label>
                        <div style="display: flex; gap: 8px; align-items: flex-end;">
                            <input type="text" id="clientAddress" placeholder="Adresse compl√®te" style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="enregistrerAdresseClient()" style="padding: 8px 16px; white-space: nowrap; font-size: 0.9rem;">
                                üíæ Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">D√©tails de l'Intervention</h3>
                <div class="input-grid">
                    <div class="input-group"><label>Date</label><input type="date" id="interventionDate"></div>
                    <div class="input-group">
                        <label>Technicien</label>
                        <select id="technicien">
                            <option value="">-- S√©lectionner un technicien --</option>
                            <option value="Christophe Tavares">Christophe Tavares</option>
                            <option value="Ricardo Dassilva">Ricardo Dassilva</option>
                            <option value="Mathieu Rodriguez">Mathieu Rodriguez</option>
                        </select>
                    </div>
                    <div class="input-group" style="display: flex; flex-direction: column; gap: 0;">
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label>üïê Heure d'arriv√©e</label>
                            <input type="time" id="heureArrivee" onchange="calculerMainOeuvre()">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 15px;">
                            <label>üïê Heure de d√©part</label>
                            <input type="time" id="heureDepart" onchange="calculerMainOeuvre()">
                        </div>
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label>Description</label>
                        <textarea id="description" rows="2" placeholder="Travaux effectu√©s..."></textarea>
                        <!-- Permet de prendre une photo OU choisir depuis la galerie -->
                        <label for="photoInput" class="btn-photo">üì∑ Ajouter une photo</label>
                        <input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="handlePhotoSelect(event)">
                        <div id="photosPreview" class="photos-preview"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">Produits Utilis√©s</h3>
                
                <!-- S√©lecteur rapide de mat√©riel -->
                <div class="material-selector">
                    <label>‚ö° Ajout rapide de mat√©riel</label>
                    <div class="material-selector-row">
                        <select id="materialSelect">
                            <option value="">-- Choisir un produit --</option>
                            <optgroup label="üîå C√¢bles">
                                <option value="0" data-price="0.6">3G0,75</option>
                                <option value="1" data-price="1.3">3G1,5</option>
                                <option value="2" data-price="2">3G2,5</option>
                                <option value="3" data-price="2.1">5G1,5</option>
                                <option value="4" data-price="3.2">5G2,5</option>
                                <option value="5" data-price="4.5">5G6</option>
                                <option value="6" data-price="14">5G10</option>
                                <option value="7" data-price="22">5G16</option>
                                <option value="8" data-price="50">4X35</option>
                                <option value="9" data-price="3">3G1,5 Pyrolion</option>
                                <option value="10" data-price="4.35">3G2,5 Pyrolion</option>
                                <option value="11" data-price="6.5">5G2,5 Pyrolion</option>
                                <option value="12" data-price="1.8">C√¢ble Info Cat.6</option>
                                <option value="13" data-price="3.4">C√¢ble Sono 2X1,5</option>
                                <option value="14" data-price="1">Gaine Grise √ò20</option>
                            </optgroup>
                            <optgroup label="üîß Disjoncteurs Mono">
                                <option value="15" data-price="37">2A Mono 6kA</option>
                                <option value="16" data-price="39">4A Mono 6kA</option>
                                <option value="17" data-price="34">10A Mono 6kA</option>
                                <option value="18" data-price="34">16A Mono 6kA</option>
                                <option value="19" data-price="34">20A Mono 6kA</option>
                                <option value="20" data-price="37">32A Mono 6kA</option>
                            </optgroup>
                            <optgroup label="üîß Disjoncteurs T√©tra">
                                <option value="21" data-price="114">10A T√©tra 6kA</option>
                                <option value="22" data-price="114">16A T√©tra 6kA</option>
                                <option value="23" data-price="114">20A T√©tra 6kA</option>
                                <option value="24" data-price="130">32A T√©tra 6kA</option>
                                <option value="25" data-price="158">40A T√©tra 6kA</option>
                                <option value="26" data-price="275">63A T√©tra 10kA</option>
                            </optgroup>
                            <optgroup label="üîå Appareillages Plexo">
                                <option value="27" data-price="15">Inter. Plexo Saillie</option>
                                <option value="28" data-price="22">Prise Plexo Simple</option>
                                <option value="29" data-price="42">Prise Plexo Double</option>
                                <option value="30" data-price="86">Prise Plexo Triple</option>
                                <option value="31" data-price="72">Prise T√©tra 20A</option>
                                <option value="32" data-price="25">Fiche T√©tra 20A</option>
                                <option value="33" data-price="8">Bo√Æte Plexo √ò60</option>
                                <option value="34" data-price="12">Bo√Æte Plexo √ò80</option>
                                <option value="35" data-price="27">Bo√Æte Plexo √ò100</option>
                                <option value="36" data-price="30">Prise Encastr√© Simple</option>
                                <option value="37" data-price="59">Prise Encastr√© Double</option>
                                <option value="38" data-price="90">Prise Encastr√© Triple</option>
                                <option value="39" data-price="67">Prise T√©tra Encastr√©</option>
                            </optgroup>
                            <optgroup label="üö® BAES & Peignes">
                                <option value="40" data-price="130">BAES Legrand</option>
                                <option value="41" data-price="120">BAES URA ONE</option>
                                <option value="42" data-price="290">T√©l√©commande BAES</option>
                                <option value="43" data-price="42">Peigne Mono DT40</option>
                                <option value="44" data-price="76">Peigne T√©tra IDT40</option>
                                <option value="45" data-price="28">Peigne T√©tra IC60</option>
                            </optgroup>
                            <optgroup label="üí° √âclairage & LED">
                                <option value="46" data-price="8">Ampoule E27 2W</option>
                                <option value="47" data-price="9">Ampoule E27 4W Dim</option>
                                <option value="48" data-price="125">Guirlande 12m</option>
                                <option value="49" data-price="9">Ampoule GU10 7W</option>
                                <option value="50" data-price="1.1">Douille GU10</option>
                                <option value="51" data-price="28">Ruban LED COB480</option>
                                <option value="52" data-price="7.6">Profil√© Alu</option>
                                <option value="53" data-price="7.2">Capot Blanc</option>
                                <option value="54" data-price="105">Transfo 24V 100W</option>
                            </optgroup>
                            <optgroup label="üéõÔ∏è Variateurs">
                                <option value="55" data-price="390">RVLED 250W</option>
                                <option value="56" data-price="430">RVLED 500W</option>
                                <option value="57" data-price="490">RVLED 1000W</option>
                                <option value="58" data-price="65">Potentiom√®tre</option>
                                <option value="59" data-price="8.5">Support Potentiom√®tre</option>
                            </optgroup>
                        </select>
                        <input type="number" id="materialQty" value="1" min="1" placeholder="Qt√©">
                        <button class="btn-add" onclick="addMaterial()">+ Ajouter</button>
                    </div>
                </div>
                
                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üîå C√¢bles</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="0"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">3G0,75</div></div><div class="product-price">0.60‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="0.6" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="1"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">3G1,5</div></div><div class="product-price">1.30‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="1.3" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="2"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">3G2,5</div></div><div class="product-price">2.00‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="2" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="3"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">5G1,5</div></div><div class="product-price">2.10‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="2.1" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="4"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">5G2,5</div></div><div class="product-price">3.20‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="3.2" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="5"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">5G6</div></div><div class="product-price">4.50‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="4.5" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="6"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">5G10</div></div><div class="product-price">14‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="14" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="7"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">5G16</div></div><div class="product-price">22‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="22" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="8"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">4X35</div></div><div class="product-price">50‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="50" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="9"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">3G1,5 Pyrolion</div></div><div class="product-price">3‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="3" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="10"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">3G2,5 Pyrolion</div></div><div class="product-price">4.35‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="4.35" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="11"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">5G2,5 Pyrolion</div></div><div class="product-price">6.50‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="6.5" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="12"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">C√¢ble Info Cat.6</div></div><div class="product-price">1.80‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="1.8" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="13"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">C√¢ble Sono 2X1,5</div></div><div class="product-price">3.40‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="3.4" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="14"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Gaine Grise √ò20</div></div><div class="product-price">1‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="1" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üîß Disjoncteurs Mono</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="15"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">2A Mono 6kA</div><div class="product-ref">A9P22602</div></div><div class="product-price">37‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="37" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="16"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">4A Mono 6kA</div><div class="product-ref">A9P22604</div></div><div class="product-price">39‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="39" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="17"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">10A Mono 6kA</div><div class="product-ref">A9P22610</div></div><div class="product-price">34‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="34" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="18"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">16A Mono 6kA</div><div class="product-ref">A9P22616</div></div><div class="product-price">34‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="34" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="19"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">20A Mono 6kA</div><div class="product-ref">A9P22620</div></div><div class="product-price">34‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="34" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="20"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">32A Mono 6kA</div><div class="product-ref">A9P22632</div></div><div class="product-price">37‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="37" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üîß Disjoncteurs T√©tra</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="21"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">10A T√©tra 6kA</div><div class="product-ref">A9P22710</div></div><div class="product-price">114‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="114" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="22"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">16A T√©tra 6kA</div><div class="product-ref">A9P22716</div></div><div class="product-price">114‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="114" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="23"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">20A T√©tra 6kA</div><div class="product-ref">A9P22720</div></div><div class="product-price">114‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="114" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="24"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">32A T√©tra 6kA</div><div class="product-ref">A9P22732</div></div><div class="product-price">130‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="130" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="25"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">40A T√©tra 6kA</div><div class="product-ref">A9P22740</div></div><div class="product-price">158‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="158" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="26"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">63A T√©tra 10kA</div><div class="product-ref">A9P24463</div></div><div class="product-price">275‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="275" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üîå Appareillages Plexo</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="27"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Inter. Plexo Saillie</div><div class="product-ref">069711L</div></div><div class="product-price">15‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="15" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="28"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise Plexo Simple</div><div class="product-ref">069731L</div></div><div class="product-price">22‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="22" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="29"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise Plexo Double</div><div class="product-ref">069768L</div></div><div class="product-price">42‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="42" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="30"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise Plexo Triple</div><div class="product-ref">069680L</div></div><div class="product-price">86‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="86" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="31"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise T√©tra 20A</div><div class="product-ref">091657</div></div><div class="product-price">72‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="72" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="32"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Fiche T√©tra 20A</div><div class="product-ref">055637</div></div><div class="product-price">25‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="25" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="33"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Bo√Æte Plexo √ò60</div><div class="product-ref">092003</div></div><div class="product-price">8‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="8" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="34"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Bo√Æte Plexo √ò80</div><div class="product-ref">092013</div></div><div class="product-price">12‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="12" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="35"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Bo√Æte Plexo √ò100</div><div class="product-ref">092020</div></div><div class="product-price">27‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="27" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="36"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise Encastr√© Simple</div><div class="product-ref">069831L</div></div><div class="product-price">30‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="30" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="37"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise Encastr√© Double</div><div class="product-ref">069562L</div></div><div class="product-price">59‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="59" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="38"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise Encastr√© Triple</div><div class="product-ref">080053</div></div><div class="product-price">90‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="90" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="39"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Prise T√©tra Encastr√©</div><div class="product-ref">080051</div></div><div class="product-price">67‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="67" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üö® BAES & Peignes</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="40"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">BAES Legrand</div><div class="product-ref">062525</div></div><div class="product-price">130‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="130" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="41"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">BAES URA ONE</div><div class="product-ref">111013V</div></div><div class="product-price">120‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="120" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="42"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">T√©l√©commande BAES</div><div class="product-ref">062520</div></div><div class="product-price">290‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="290" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="43"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Peigne Mono DT40</div><div class="product-ref">A9XPN624</div></div><div class="product-price">42‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="42" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="44"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Peigne T√©tra IDT40</div><div class="product-ref">A9XPP724</div></div><div class="product-price">76‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="76" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="45"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Peigne T√©tra IC60</div><div class="product-ref">R9PXH424</div></div><div class="product-price">28‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="28" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üí° √âclairage & LED</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="46"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Ampoule E27 2W</div><div class="product-ref">716630</div></div><div class="product-price">8‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="8" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="47"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Ampoule E27 4W Dim</div><div class="product-ref">165458</div></div><div class="product-price">9‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="9" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="48"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Guirlande 12m</div></div><div class="product-price">125‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="125" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="49"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Ampoule GU10 7W</div></div><div class="product-price">9‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="9" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="50"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Douille GU10</div></div><div class="product-price">1.10‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="1.1" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="51"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Ruban LED COB480</div></div><div class="product-price">28‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="28" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="52"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Profil√© Alu</div></div><div class="product-price">7.60‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="7.6" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="53"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Capot Blanc</div></div><div class="product-price">7.20‚Ç¨/m</div><div class="product-qty"><input type="number" value="0" min="0" data-price="7.2" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="54"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Transfo 24V 100W</div></div><div class="product-price">105‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="105" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>

                <div class="category-section">
                    <div class="category-header collapsed" onclick="toggleCategory(this)"><span>üéõÔ∏è Variateurs</span><span class="toggle-icon">‚ñº</span></div>
                    <div class="category-content hidden">
                        <div class="product-row" data-index="55"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">RVLED 250W</div></div><div class="product-price">390‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="390" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="56"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">RVLED 500W</div></div><div class="product-price">430‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="430" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="57"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">RVLED 1000W</div></div><div class="product-price">490‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="490" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="58"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Potentiom√®tre</div><div class="product-ref">1977</div></div><div class="product-price">65‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="65" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                        <div class="product-row" data-index="59"><input type="checkbox" onchange="updateTotal(this)"><div><div class="product-name">Support Potentiom√®tre</div><div class="product-ref">A9A15152</div></div><div class="product-price">8.50‚Ç¨</div><div class="product-qty"><input type="number" value="0" min="0" data-price="8.5" onchange="updateRowTotal(this)"></div><div class="product-total">0.00‚Ç¨</div></div>
                    </div>
                </div>
            </div>

            <!-- R√©cap produits ajout√©s par le technicien -->
            <div class="section">
                <h3 class="section-title">R√©capitulatif des produits ajout√©s</h3>
                <div id="selectedProductsList" style="font-size:0.9rem; border:1px solid var(--border); border-radius:8px; padding:10px 12px; background:#f8fafc;">
                    <p style="color:var(--text-light);">Aucun produit s√©lectionn√© pour le moment.</p>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">Main d'≈íuvre & D√©placement</h3>
                <div class="service-row">
                    <label>üîß Main d'≈ìuvre</label>
                    <input type="text" id="moDuree" value="0h00" readonly style="background:#f0f0f0; cursor:not-allowed; flex:1;" placeholder="Temps pass√©">
                    <input type="text" id="moDemiHeures" value="0 demi-heures" readonly style="background:#f0f0f0; cursor:not-allowed; text-align:center; display:none;" placeholder="Demi-heures">
                    <input type="number" id="moTarif" value="35" min="0" placeholder="‚Ç¨/demi-h" style="display:none;">
                    <div class="product-total" id="moTotal" style="display:none;">0.00‚Ç¨</div>
                </div>
                <div class="service-row">
                    <label>üöó D√©placement</label>
                    <input type="number" id="deplNombre" value="0" min="0" max="10" placeholder="0, 1, 2..." onchange="updateDepl()">
                    <!-- Champ cach√© pour le calcul (non visible pour le technicien) -->
                    <input type="number" id="deplTarif" value="70" min="0" style="display:none !important; visibility:hidden; position:absolute; width:0; height:0; opacity:0;">
                    <div class="product-total" id="deplTotal" style="display:none !important;">0.00‚Ç¨</div>
                </div>
            </div>

            <div class="totals-section">
                <div class="total-row"><span>Sous-total Produits</span><span id="subtotalProduits">0.00‚Ç¨</span></div>
                <div class="total-row"><span>Main d'≈ìuvre</span><span id="subtotalMO">0.00‚Ç¨</span></div>
                <div class="total-row"><span>D√©placement</span><span id="subtotalDepl">0.00‚Ç¨</span></div>
                <div class="total-row"><span>Total HT</span><span id="totalHT">0.00‚Ç¨</span></div>
                <div class="total-row"><span>TVA (20%)</span><span id="totalTVA">0.00‚Ç¨</span></div>
                <div class="total-row grand-total"><span>TOTAL TTC</span><span id="totalTTC">0.00‚Ç¨</span></div>
            </div>

            <div class="signature-section">
                <div class="signature-box">
                    <h4>Signature Technicien</h4>
                    <canvas class="signature-canvas" id="signatureTech"></canvas>
                    <div class="signature-actions"><button class="btn-clear" onclick="clearSignature('signatureTech')">Effacer</button></div>
                </div>
                <div class="signature-box">
                    <h4>Signature Client</h4>
                    <canvas class="signature-canvas" id="signatureClient"></canvas>
                    <div class="signature-actions"><button class="btn-clear" onclick="clearSignature('signatureClient')">Effacer</button></div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Imprimer</button>
                <button class="btn btn-primary" onclick="saveBonTech()">üíæ Enregistrer le bon et envoyer au client</button>
            </div>
            <div id="saveMessage" class="save-message">Bon enregistr√©.</div>
        </div>

        <div class="footer">Compagnie d'√âlectricit√© Parisienne ‚Äî Bon d'intervention</div>
    </div>

    <!-- Lightbox d'aper√ßu des photos -->
    <div id="photoLightbox" class="photo-lightbox" onclick="closePhotoLightbox()">
        <button type="button" class="photo-lightbox-close" onclick="closePhotoLightbox(); event.stopPropagation();">√ó</button>
        <img id="photoLightboxImg" src="" alt="Aper√ßu photo">
    </div>

    <div class="modal-overlay" id="successModal">
        <div class="modal">
            <div class="modal-icon">‚úì</div>
            <h3>Envoy√© !</h3>
            <p>Le bon a √©t√© envoy√© √†<br><strong><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dab9b5b7aaaebb9ab9bfaaedeff4bca8">[email&#160;protected]</a></strong></p>
            <button class="btn btn-primary" onclick="closeModal()" style="width:100%">Fermer</button>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <!-- Firebase v8 (app + firestore + storage) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAuX2gsGiRGqVbsk93y0wmwJOsT-RuEkE4",
            authDomain: "bon-d-intervention-cep.firebaseapp.com",
            projectId: "bon-d-intervention-cep",
            storageBucket: "bon-d-intervention-cep.firebasestorage.app",
            messagingSenderId: "323636987494",
            appId: "1:323636987494:web:0b07cffbb086c767320fa7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        let photosBon = [];

        // ============================================
        // NOTIFICATIONS - Comptage des bons en attente
        // ============================================
        async function mettreAJourBadgeNotifications() {
            try {
                // Charger tous les bons et filtrer localement (√©vite les probl√®mes d'index)
                const snapshot = await db.collection('bons').get();
                const nombreEnAttente = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    return data.statut === 'en_attente' || (!data.statut && data.createdAt); // Si pas de statut, consid√©rer comme en attente
                }).length;
                
                // Mettre √† jour le badge visuel dans l'interface
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    if (nombreEnAttente > 0) {
                        badge.textContent = nombreEnAttente > 99 ? '99+' : nombreEnAttente;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                // Mettre √† jour le badge de l'ic√¥ne d'application (iOS/Android)
                if ('setAppBadge' in navigator) {
                    if (nombreEnAttente > 0) {
                        await navigator.setAppBadge(nombreEnAttente);
                    } else {
                        await navigator.clearAppBadge();
                    }
                }
                
                // Envoyer au service worker pour les appareils qui le n√©cessitent
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'SET_BADGE',
                        count: nombreEnAttente
                    });
                }
            } catch (error) {
                console.error('Erreur lors du comptage des bons en attente:', error);
                // Masquer le badge en cas d'erreur
                const badge = document.getElementById('notificationBadge');
                if (badge) badge.style.display = 'none';
                // Effacer le badge de l'ic√¥ne en cas d'erreur
                if ('clearAppBadge' in navigator) {
                    navigator.clearAppBadge().catch(() => {});
                }
            }
        }

        // Enregistrer le service worker pour les badges
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker enregistr√©:', registration);
                    })
                    .catch(error => {
                        console.log('Erreur enregistrement Service Worker:', error);
                    });
            });
        }

        // Mettre √† jour le badge au chargement et toutes les 30 secondes
        mettreAJourBadgeNotifications();
        setInterval(mettreAJourBadgeNotifications, 30000); // Mise √† jour toutes les 30 secondes

        // ============================================
        // CONFIGURATION EMAILJS (pour comptabilit√©)
        // ============================================
        const EMAILJS_CONFIG = {
            publicKey: "GXDaMfa8u-ZzmkvNn",  // Public Key (d√©j√† dans emailjs.init)
            serviceID: "service_b6ibqvh",     // Service ID depuis le dashboard EmailJS
            templateID: "template_qsnhl5e",  // Template ID depuis le dashboard EmailJS
        };
        // ============================================
        
        // ============================================
        // CONFIGURATION SMTP OVH (pour envoi client avec PDF)
        // ============================================
        const SMTP_API_URL = 'https://bon-intervention-cep.vercel.app/api/send-email';
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            document.getElementById('currentDate').textContent = today.toLocaleDateString('fr-FR');
            document.getElementById('interventionDate').valueAsDate = today;
            // Le num√©ro sera g√©n√©r√© automatiquement lors de l'enregistrement
            document.getElementById('bonNumber').textContent = 'En attente...';
            initSignature('signatureTech');
            initSignature('signatureClient');
        });


        function toggleCategory(header) {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('hidden');
        }

        // Ajout rapide de mat√©riel via le menu d√©roulant
        function addMaterial() {
            const select = document.getElementById('materialSelect');
            const qtyInput = document.getElementById('materialQty');
            const index = select.value;
            const qty = parseInt(qtyInput.value) || 1;
            
            if (index === '') {
                return;
            }
            
            // Trouver la ligne correspondante
            const row = document.querySelector(`.product-row[data-index="${index}"]`);
            if (row) {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const qtyField = row.querySelector('.product-qty input');
                const currentQty = parseInt(qtyField.value) || 0;
                
                qtyField.value = currentQty + qty;
                checkbox.checked = true;
                row.classList.add('selected');
                updateRowTotal(qtyField);

                // On n'ouvre plus automatiquement les cat√©gories : l'ajout se fait en "silence"
            }
            
            // Reset
            select.value = '';
            qtyInput.value = 1;
        }

        function updateRowTotal(input) {
            const row = input.closest('.product-row');
            const checkbox = row.querySelector('input[type="checkbox"]');
            const qty = parseFloat(input.value) || 0;
            const price = parseFloat(input.dataset.price) || 0;
            row.querySelector('.product-total').textContent = (qty * price).toFixed(2) + '‚Ç¨';
            checkbox.checked = qty > 0;
            row.classList.toggle('selected', qty > 0);
            calculateTotals();
        }

        function updateTotal(checkbox) {
            const row = checkbox.closest('.product-row');
            row.classList.toggle('selected', checkbox.checked);
            if (!checkbox.checked) {
                row.querySelector('.product-qty input').value = 0;
                row.querySelector('.product-total').textContent = '0.00‚Ç¨';
            }
            calculateTotals();
        }

        function calculerMainOeuvre() {
            const heureArrivee = document.getElementById('heureArrivee').value;
            const heureDepart = document.getElementById('heureDepart').value;
            
            if (!heureArrivee || !heureDepart) {
                document.getElementById('moDuree').value = '0h00';
                document.getElementById('moDemiHeures').value = '0 demi-heures';
                document.getElementById('moTotal').textContent = '0.00‚Ç¨';
                calculateTotals();
                return;
            }
            
            // Convertir les heures en minutes
            const [hArr, mArr] = heureArrivee.split(':').map(Number);
            const [hDep, mDep] = heureDepart.split(':').map(Number);
            const minutesArrivee = hArr * 60 + mArr;
            const minutesDepart = hDep * 60 + mDep;
            
            // Calculer la dur√©e en minutes
            let dureeMinutes = minutesDepart - minutesArrivee;
            
            // G√©rer le cas o√π le d√©part est le lendemain (apr√®s minuit)
            if (dureeMinutes < 0) {
                dureeMinutes += 24 * 60; // Ajouter 24 heures
            }
            
            // Convertir en heures et minutes pour l'affichage
            const heures = Math.floor(dureeMinutes / 60);
            const minutes = dureeMinutes % 60;
            document.getElementById('moDuree').value = heures + 'h' + String(minutes).padStart(2, '0');
            
            // Calculer le nombre de demi-heures (arrondi au demi-heure sup√©rieur)
            const demiHeures = Math.ceil(dureeMinutes / 30);
            document.getElementById('moDemiHeures').value = demiHeures + ' demi-heure' + (demiHeures > 1 ? 's' : '');
            
            // Calculer le total : nombre de demi-heures √ó 35‚Ç¨
            const tarifDemiHeure = 35;
            const totalMO = demiHeures * tarifDemiHeure;
            document.getElementById('moTotal').textContent = totalMO.toFixed(2) + '‚Ç¨';
            
            calculateTotals();
        }

        function updateMO() {
            // Cette fonction n'est plus utilis√©e, mais on la garde pour compatibilit√©
            calculerMainOeuvre();
        }

        function updateDepl() {
            const nombre = parseFloat(document.getElementById('deplNombre').value) || 0;
            const tarifForfait = 70; // 70‚Ç¨ par d√©placement
            const total = nombre * tarifForfait;
            document.getElementById('deplTotal').textContent = total.toFixed(2) + '‚Ç¨';
            calculateTotals();
        }

        function calculateTotals() {
            let sub = 0;
            document.querySelectorAll('.product-row').forEach(row => {
                if (row.querySelector('input[type="checkbox"]')?.checked) {
                    sub += parseFloat(row.querySelector('.product-total').textContent) || 0;
                }
            });
            const mo = parseFloat(document.getElementById('moTotal').textContent) || 0;
            const depl = parseFloat(document.getElementById('deplTotal').textContent) || 0;
            const ht = sub + mo + depl;
            const tva = ht * 0.2;
            document.getElementById('subtotalProduits').textContent = sub.toFixed(2) + '‚Ç¨';
            document.getElementById('subtotalMO').textContent = mo.toFixed(2) + '‚Ç¨';
            document.getElementById('subtotalDepl').textContent = depl.toFixed(2) + '‚Ç¨';
            document.getElementById('totalHT').textContent = ht.toFixed(2) + '‚Ç¨';
            document.getElementById('totalTVA').textContent = tva.toFixed(2) + '‚Ç¨';
            document.getElementById('totalTTC').textContent = (ht + tva).toFixed(2) + '‚Ç¨';

            // Mettre √† jour le r√©cap des produits s√©lectionn√©s (vue technicien)
            const container = document.getElementById('selectedProductsList');
            if (container) {
                const lignes = [];
                document.querySelectorAll('.product-row').forEach(row => {
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    const qtyInput = row.querySelector('.product-qty input');
                    const qty = parseFloat(qtyInput.value) || 0;
                    if (checkbox && checkbox.checked && qty > 0) {
                        const name = row.querySelector('.product-name')?.textContent || '';
                        lignes.push({ name, qty });
                    }
                });

                if (lignes.length === 0) {
                    container.innerHTML = "<p style=\"color:var(--text-light);\">Aucun produit s√©lectionn√© pour le moment.</p>";
                } else {
                    container.innerHTML = lignes.map(l => 
                        `<div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed var(--border);">
                            <span>${l.name}</span>
                            <span style="font-family:'Space Mono', monospace;">Qt√© : ${l.qty}</span>
                        </div>`
                    ).join("");
                }
            }
        }

        function initSignature(id) {
            const canvas = document.getElementById(id);
            const ctx = canvas.getContext('2d');
            let drawing = false;
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.strokeStyle = '#1a365d';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';

            function pos(e) {
                const r = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - r.left;
                const y = (e.clientY || e.touches[0].clientY) - r.top;
                return {x, y};
            }
            canvas.onmousedown = e => { drawing = true; ctx.beginPath(); ctx.moveTo(pos(e).x, pos(e).y); };
            canvas.onmousemove = e => { if (drawing) { ctx.lineTo(pos(e).x, pos(e).y); ctx.stroke(); } };
            canvas.onmouseup = canvas.onmouseout = () => drawing = false;
            canvas.ontouchstart = e => { e.preventDefault(); drawing = true; ctx.beginPath(); ctx.moveTo(pos(e).x, pos(e).y); };
            canvas.ontouchmove = e => { e.preventDefault(); if (drawing) { ctx.lineTo(pos(e).x, pos(e).y); ctx.stroke(); } };
            canvas.ontouchend = () => drawing = false;
        }

        function clearSignature(id) {
            const c = document.getElementById(id);
            c.getContext('2d').clearRect(0, 0, c.width, c.height);
        }

        function toggleAdmin() {
            const code = prompt("Code administrateur :");
            // Pour le patron : acc√®s √† la page r√©cap avec tous les bons chiffr√©s
            if (code === "CEP2024") {
                // Stocker l'authentification dans sessionStorage pour √©viter de redemander le code
                sessionStorage.setItem('adminAuthenticated', 'true');
                window.location.href = "admin.html";
            } else if (code !== null) {
                alert("Code incorrect.");
            }
        }

        async function envoyerClient() {
            const email = (document.getElementById('clientEmail').value || '').trim();
            if (!email) {
                return;
            }
            
            console.log("=== D√âBUT ENVOI EMAIL CLIENT VIA SMTP OVH ===");
            
            // R√©cup√©rer les informations du formulaire
            const numeroBon = document.getElementById('bonNumber').textContent;
            const date = document.getElementById('interventionDate').value || '';
            const client = document.getElementById('clientName').value || 'Client';
            const clientPhone = (document.getElementById('clientPhone')?.value || '').trim();
            const clientAddress = document.getElementById('clientAddress').value || '';
            const technicien = document.getElementById('technicien').value || 'Non sp√©cifi√©';
            const description = document.getElementById('description').value || '';
            
            // Main d'≈ìuvre (sans prix pour le client)
            const moDuree = document.getElementById('moDuree').value || '0h00';
            
            // D√©placement (sans prix pour le client)
            const deplNombre = document.getElementById('deplNombre').value || '0';
            
            // R√©cup√©rer les produits utilis√©s (sans prix)
            let produitsHtml = '';
            const produitsUtilises = [];
            document.querySelectorAll('.product-row').forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const qtyInput = row.querySelector('.product-qty input');
                const qty = parseFloat(qtyInput.value) || 0;
                if (checkbox && checkbox.checked && qty > 0) {
                    const name = row.querySelector('.product-name')?.textContent || '';
                    const ref = row.querySelector('.product-ref')?.textContent || '';
                    produitsUtilises.push({ nom: name, reference: ref, quantite: qty });
                }
            });
            
            if (produitsUtilises.length > 0) {
                produitsHtml = '\n\nüì¶ MAT√âRIEL UTILIS√â :\n';
                produitsHtml += '‚îÄ'.repeat(50) + '\n';
                produitsUtilises.forEach(p => {
                    produitsHtml += `‚Ä¢ ${p.nom || ''}`;
                    if (p.reference) produitsHtml += ` (R√©f: ${p.reference})`;
                    produitsHtml += ` - Quantit√©: ${p.quantite || 0}\n`;
                });
            } else {
                produitsHtml = '\n\nüì¶ MAT√âRIEL UTILIS√â : Aucun\n';
            }
            
            // R√©cup√©rer les photos
            let photosHtml = '';
            if (photosBon && photosBon.length > 0) {
                photosHtml = '\n\nüì∑ PHOTOS DE L\'INTERVENTION :\n';
                photosHtml += '‚îÄ'.repeat(50) + '\n';
                photosBon.forEach((photo, index) => {
                    const url = typeof photo === 'string' ? photo : photo.url;
                    if (url) {
                        photosHtml += `Photo ${index + 1}: ${url}\n`;
                    }
                });
            } else {
                photosHtml = '\n\nüì∑ PHOTOS : Aucune photo\n';
            }
            
            // Construire le corps de l'email (sans prix pour le client)
            let body = `Bonjour,\n\n`;
            body += `BON D'INTERVENTION ${numeroBon}\n`;
            body += '‚ïê'.repeat(50) + '\n\n';
            body += `üìÖ Date : ${date}\n`;
            body += `üë§ Client : ${client}\n`;
            if (clientPhone) body += `T√©l√©phone : ${clientPhone}\n`;
            if (clientAddress) body += `üìç Adresse : ${clientAddress}\n`;
            body += `üîß Technicien : ${technicien}\n`;
            if (description) body += `üìù Description : ${description}\n`;
            
            body += produitsHtml;
            
            body += '\n‚è±Ô∏è TEMPS DE TRAVAIL :\n';
            body += '‚îÄ'.repeat(50) + '\n';
            body += `Dur√©e : ${moDuree}\n`;
            
            body += '\nüöó D√âPLACEMENT :\n';
            body += '‚îÄ'.repeat(50) + '\n';
            body += `Nombre de d√©placements : ${deplNombre}\n`;
            
            body += photosHtml;
            
            body += '\n\n‚îÄ'.repeat(50) + '\n';
            body += 'Cordialement,\n';
            body += 'Compagnie d\'√âlectricit√© Parisienne\n';
            
            // R√©cup√©rer les heures d'arriv√©e et de d√©part
            const heureArrivee = document.getElementById('heureArrivee').value || '';
            const heureDepart = document.getElementById('heureDepart').value || '';
            
            // G√©n√©rer le PDF et l'envoyer en pi√®ce jointe via SMTP OVH
            try {
                console.log('=== D√âBUT G√âN√âRATION PDF ===');
                console.log('V√©rification jsPDF...', typeof window.jspdf !== 'undefined');
                
                const pdfBlob = await genererPDFBon();
                console.log('PDF g√©n√©r√©, taille:', pdfBlob.size, 'bytes');
                
                // Convertir le PDF en base64 pour l'envoyer via l'API
                const pdfBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result.split(',')[1]; // Enlever le pr√©fixe data:application/pdf;base64,
                        resolve(base64String);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(pdfBlob);
                });
                
                console.log('PDF converti en base64, longueur:', pdfBase64.length);
                
                // Pr√©parer les donn√©es du bon pour l'email
                const bonData = {
                    numero: numeroBon,
                    date: date,
                    client: client,
                    adresse: clientAddress,
                    telephone: clientPhone,
                    technicien: technicien,
                    description: description,
                    heure_arrivee: heureArrivee,
                    heure_depart: heureDepart
                };
                
                // Pr√©parer les photos pour l'email
                const photosPourEmail = [];
                if (photosBon && photosBon.length > 0) {
                    photosBon.forEach((photo, index) => {
                        try {
                            let base64Data = null;
                            
                            // Si c'est un objet avec base64
                            if (photo && photo.base64) {
                                base64Data = photo.base64;
                            }
                            // Si c'est une cha√Æne (URL ou base64 direct)
                            else if (typeof photo === 'string') {
                                // Si c'est d√©j√† en base64 (commence par data:)
                                if (photo.startsWith('data:')) {
                                    base64Data = photo;
                                }
                                // Sinon c'est une URL, on ne peut pas l'utiliser directement
                                else {
                                    console.warn(`Photo ${index + 1}: URL non support√©e pour l'email, base64 requis`);
                                    return;
                                }
                            }
                            
                            if (base64Data) {
                                photosPourEmail.push({
                                    base64: base64Data
                                });
                            }
                        } catch (error) {
                            console.error(`Erreur lors de la pr√©paration de la photo ${index + 1}:`, error);
                        }
                    });
                }
                
                console.log(`Photos pr√©par√©es pour l'email: ${photosPourEmail.length} sur ${photosBon.length}`);
                
                // Envoyer l'email avec PDF et photos en pi√®ces jointes via SMTP OVH (Nodemailer)
                console.log('=== ENVOI EMAIL CLIENT VIA SMTP ===');
                console.log('Email destinataire:', email);
                console.log('Sujet:', `Bon d'intervention ${numeroBon} - ${client}`);
                console.log('Taille PDF base64:', pdfBase64.length, 'caract√®res');
                console.log('Nombre de photos:', photosPourEmail.length);
                
                await envoyerEmailAvecPDFSMTP({
                    email: email,
                    subject: `Bon d'intervention ${numeroBon} - ${client}`,
                    pdfBase64: pdfBase64,
                    pdfFileName: `bon-intervention-${numeroBon}.pdf`,
                    bonData: bonData,
                    photos: photosPourEmail
                });
                
                console.log('‚úÖ Email envoy√© avec succ√®s au client');
                alert(`‚úÖ Email envoy√© au client avec succ√®s !\n\nLe bon d'intervention a √©t√© envoy√© √† ${email}`);
                
            } catch (pdfError) {
                console.error('‚ùå ERREUR lors de la g√©n√©ration/envoi du PDF:', pdfError);
                console.error('D√©tails:', pdfError.message, pdfError.stack);
                alert("‚ö†Ô∏è Erreur lors de l'envoi de l'email avec PDF.\n\nErreur: " + (pdfError.message || pdfError) + "\n\nV√©rifiez la console (F12) pour plus de d√©tails.");
                throw pdfError;
            }
        }

        // Fonction pour g√©n√©rer le PDF du bon d'intervention
        async function genererPDFBon() {
            // V√©rifier que jsPDF est charg√©
            if (typeof window.jspdf === 'undefined') {
                throw new Error("jsPDF n'est pas charg√©. Veuillez recharger la page.");
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            console.log('jsPDF initialis√©, d√©but g√©n√©ration PDF...');
            
            // Informations CEP
            const infoCEP = {
                nom: "CEP - √âlectricit√© G√©n√©rale, Installation, D√©pannage",
                adresse: "6, rue de Metz, 94240 L'Ha√ø-les-Roses",
                tel: "T√©l. 01 56 04 19 96",
                email: "contact@cep75.fr",
                web: "www.cep75.fr"
            };
            
            // R√©cup√©rer les donn√©es du formulaire
            const numeroBon = document.getElementById('bonNumber').textContent;
            const date = document.getElementById('interventionDate').value || '';
            const client = document.getElementById('clientName').value || '';
            const clientAddress = document.getElementById('clientAddress').value || '';
            const technicien = document.getElementById('technicien').value || '';
            const heureArrivee = document.getElementById('heureArrivee').value || '';
            const heureDepart = document.getElementById('heureDepart').value || '';
            const description = document.getElementById('description').value || '';
            // totalTTC non utilis√© pour le client (PDF sans montants)
            
            // R√©cup√©rer les produits (sans prix pour le client)
            const produits = [];
            document.querySelectorAll('.product-row').forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const qtyInput = row.querySelector('.product-qty input');
                const qty = parseFloat(qtyInput.value) || 0;
                if (checkbox && checkbox.checked && qty > 0) {
                    const name = row.querySelector('.product-name')?.textContent || '';
                    const ref = row.querySelector('.product-ref')?.textContent || '';
                    // Prix non utilis√© pour le client (PDF sans montants)
                    produits.push({ nom: name, reference: ref, quantite: qty });
                }
            });
            
            // R√©cup√©rer les signatures
            const signatureTech = document.getElementById('signatureTech');
            const signatureClient = document.getElementById('signatureClient');
            let sigTechData = null;
            let sigClientData = null;
            try {
                if (signatureTech && signatureTech.toDataURL) {
                    sigTechData = signatureTech.toDataURL('image/png');
                }
                if (signatureClient && signatureClient.toDataURL) {
                    sigClientData = signatureClient.toDataURL('image/png');
                }
            } catch(e) {
                console.error('Erreur r√©cup√©ration signatures:', e);
            }
            
            let yPos = 20;
            
            // En-t√™te CEP
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(infoCEP.nom, 105, yPos, { align: 'center' });
            yPos += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(infoCEP.adresse, 105, yPos, { align: 'center' });
            yPos += 5;
            doc.text(infoCEP.tel, 105, yPos, { align: 'center' });
            yPos += 5;
            doc.text(infoCEP.email + ' / ' + infoCEP.web, 105, yPos, { align: 'center' });
            yPos += 10;
            
            // Ligne de s√©paration
            doc.setLineWidth(0.5);
            doc.line(20, yPos, 190, yPos);
            yPos += 8;
            
            // Num√©ro du bon et titre
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('BON D\'INTERVENTION', 105, yPos, { align: 'center' });
            yPos += 6;
            doc.setFontSize(12);
            doc.text('N¬∞ ' + numeroBon, 105, yPos, { align: 'center' });
            yPos += 10;
            
            // Informations client
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('CLIENT :', 20, yPos);
            yPos += 6;
            doc.setFont(undefined, 'normal');
            doc.text(client, 20, yPos);
            yPos += 5;
            if (clientAddress) {
                doc.text(clientAddress, 20, yPos);
                yPos += 5;
            }
            yPos += 3;
            
            // Informations intervention
            doc.setFont(undefined, 'bold');
            doc.text('INTERVENTION :', 20, yPos);
            yPos += 6;
            doc.setFont(undefined, 'normal');
            doc.text('Date : ' + date, 20, yPos);
            yPos += 5;
            doc.text('Intervenant : ' + technicien, 20, yPos);
            yPos += 5;
            if (heureArrivee) doc.text('Heure d\'arriv√©e : ' + heureArrivee, 20, yPos);
            if (heureDepart) {
                if (heureArrivee) yPos += 5;
                doc.text('Heure de d√©part : ' + heureDepart, 20, yPos);
            }
            yPos += 8;
            
            // Description
            if (description) {
                doc.setFont(undefined, 'bold');
                doc.text('DESCRIPTION :', 20, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                const descLines = doc.splitTextToSize(description, 170);
                doc.text(descLines, 20, yPos);
                yPos += descLines.length * 5 + 3;
            }
            
            // Photos de l'intervention
            console.log('=== V√âRIFICATION PHOTOS ===');
            console.log('photosBon existe?', typeof photosBon !== 'undefined');
            console.log('photosBon:', photosBon);
            console.log('Nombre de photos:', photosBon ? photosBon.length : 0);
            
            if (photosBon && photosBon.length > 0) {
                console.log(`Ajout de ${photosBon.length} photo(s) au PDF...`);
                
                // V√©rifier si on a besoin d'une nouvelle page
                if (yPos > 200) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('PHOTOS DE L\'INTERVENTION :', 20, yPos);
                yPos += 8;
                
                const photoWidth = 80; // Largeur des photos en mm
                const photoHeight = 60; // Hauteur des photos en mm
                const photosPerRow = 2; // 2 photos par ligne
                const spacing = 10; // Espacement entre les photos
                
                for (let i = 0; i < photosBon.length; i++) {
                    const photo = photosBon[i];
                    if (!photo) continue;
                    
                    // R√©cup√©rer le base64 (nouveau format) ou l'URL (ancien format pour compatibilit√©)
                    let imgData;
                    if (typeof photo === 'object' && photo.base64) {
                        // Nouveau format : utiliser directement le base64 stock√©
                        imgData = photo.base64;
                        console.log(`Photo ${i + 1}: utilisation base64 stock√© (${imgData.length} caract√®res)`);
                    } else if (typeof photo === 'string') {
                        // Ancien format : convertir l'URL en base64 (fallback pour compatibilit√©)
                        console.warn(`Photo ${i + 1}: format ancien d√©tect√©, conversion n√©cessaire`);
                        try {
                            const img = await new Promise((resolve, reject) => {
                                const imgElement = new Image();
                                imgElement.crossOrigin = 'anonymous';
                                imgElement.onload = () => resolve(imgElement);
                                imgElement.onerror = reject;
                                imgElement.src = photo;
                            });
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            imgData = canvas.toDataURL('image/jpeg', 0.8);
                        } catch (err) {
                            console.error(`Erreur conversion photo ${i + 1}:`, err);
                            continue; // Passer √† la photo suivante
                        }
                    } else {
                        console.warn(`Photo ${i + 1}: format inconnu, ignor√©e`);
                        continue;
                    }
                    
                    // V√©rifier si on a besoin d'une nouvelle page
                    if (yPos + photoHeight > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Calculer la position X (2 photos par ligne)
                    const col = i % photosPerRow;
                    const xPos = 20 + col * (photoWidth + spacing);
                    
                    try {
                        // Ajouter l'image au PDF directement depuis le base64
                        doc.addImage(imgData, 'JPEG', xPos, yPos, photoWidth, photoHeight);
                        
                        // Ajouter un num√©ro sous la photo
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'normal');
                        doc.text(`Photo ${i + 1}`, xPos + photoWidth / 2, yPos + photoHeight + 4, { align: 'center' });
                        
                    } catch (photoError) {
                        console.error(`‚ùå Erreur ajout photo ${i + 1} au PDF:`, photoError);
                        // En cas d'erreur, afficher un message et continuer
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        doc.text(`Photo ${i + 1} (erreur)`, xPos, yPos + 10);
                    }
                    
                    // Passer √† la ligne suivante apr√®s 2 photos
                    if ((i + 1) % photosPerRow === 0) {
                        yPos += photoHeight + 12; // Hauteur photo + espacement
                    }
                }
                
                // Si le nombre de photos est impair, passer √† la ligne suivante
                if (photosBon.length % photosPerRow !== 0) {
                    yPos += photoHeight + 12;
                }
                
                yPos += 5; // Espacement avant la section suivante
            }
            
            // Mat√©riel pos√©
            if (produits.length > 0) {
                doc.setFont(undefined, 'bold');
                doc.text('MAT√âRIEL POS√â :', 20, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                
                produits.forEach(p => {
                    // Version client : SANS AUCUN PRIX - uniquement nom, r√©f√©rence et quantit√©
                    // V√©rifier qu'aucun prix n'est pr√©sent dans l'objet produit
                    if (p.prix !== undefined) {
                        console.warn('‚ö†Ô∏è ATTENTION: Prix d√©tect√© dans produit pour client:', p);
                    }
                    const ligne = `${p.nom}${p.reference ? ' (Ref: ' + p.reference + ')' : ''} - Quantit√©: ${p.quantite}`;
                    console.log('Ligne produit (client, sans prix):', ligne);
                    const lignes = doc.splitTextToSize(ligne, 170);
                    doc.text(lignes, 20, yPos);
                    yPos += lignes.length * 4;
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                });
                yPos += 3;
            }
            
            // Total TTC - masqu√© pour le client
            // doc.setFontSize(11);
            // doc.setFont(undefined, 'bold');
            // doc.text('TOTAL TTC : ' + totalTTC, 20, yPos);
            // yPos += 10;
            
            // Signatures
            if (sigTechData || sigClientData) {
                const sigWidth = 70;
                const sigHeight = 30;
                
                if (sigTechData) {
                    doc.setFontSize(9);
                    doc.text('Signature Intervenant :', 20, yPos);
                    yPos += 5;
                    try {
                        doc.addImage(sigTechData, 'PNG', 20, yPos, sigWidth, sigHeight);
                    } catch(e) {
                        console.error('Erreur ajout signature technicien:', e);
                    }
                }
                
                if (sigClientData) {
                    if (sigTechData) {
                        yPos = yPos - 5; // R√©aligner
                    }
                    doc.setFontSize(9);
                    doc.text('Signature Client :', 120, yPos - 5);
                    if (!sigTechData) yPos += 5;
                    try {
                        doc.addImage(sigClientData, 'PNG', 120, yPos, sigWidth, sigHeight);
                    } catch(e) {
                        console.error('Erreur ajout signature client:', e);
                    }
                }
            }
            
            // Section Paiement rapide - UNIQUEMENT pour l'admin, PAS pour le technicien
            // Le technicien envoie un "BON D'INTERVENTION" sans section paiement
            // (Pas de section paiement dans le PDF du technicien)
            
            // G√©n√©rer le PDF en blob
            const pdfBlob = doc.output('blob');
            return pdfBlob;
        }
        
        // Fonction pour envoyer l'email au client avec PDF en pi√®ce jointe via SMTP OVH (Nodemailer)
        async function envoyerEmailAvecPDFSMTP(data) {
            try {
                console.log('=== ENVOI EMAIL AVEC PDF VIA SMTP OVH ===');
                console.log('Email destination:', data.email);
                console.log('URL API:', SMTP_API_URL);
                console.log('Nombre de photos:', data.photos ? data.photos.length : 0);
                
                if (!SMTP_API_URL || SMTP_API_URL.includes('votre-projet')) {
                    throw new Error('SMTP_API_URL non configur√©e. Veuillez configurer l\'URL de votre API Vercel dans index.html (ligne ~520)');
                }
                
                const requestBody = {
                    email: data.email,
                    subject: data.subject,
                    pdfBase64: data.pdfBase64,
                    pdfFileName: data.pdfFileName,
                    bonData: data.bonData,
                    photos: data.photos || []
                };
                
                console.log('Donn√©es envoy√©es:', {
                    email: requestBody.email,
                    subject: requestBody.subject,
                    pdfSize: requestBody.pdfBase64.length,
                    photosCount: requestBody.photos.length
                });
                
                // D√©tecter si on est sur mobile
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                const timeout = isMobile ? 60000 : 30000; // 60s sur mobile, 30s sur PC
                
                console.log('Appareil d√©tect√©:', isMobile ? 'Mobile' : 'PC', '- Timeout:', timeout + 'ms');
                
                // Cr√©er un AbortController pour g√©rer le timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                const response = await fetch(SMTP_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('R√©ponse re√ßue, status:', response.status, response.statusText);
                
                let result;
                try {
                    const responseText = await response.text();
                    console.log('R√©ponse texte:', responseText.substring(0, 200));
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Erreur parsing r√©ponse:', parseError);
                    throw new Error(`Erreur de r√©ponse du serveur (${response.status}): ${response.statusText}`);
                }
                
                if (!response.ok) {
                    throw new Error(result.error || `Erreur HTTP ${response.status}: ${response.statusText}`);
                }
                
                console.log('Email envoy√© avec succ√®s via SMTP OVH:', result);
                const photosCount = data.photos ? data.photos.length : 0;
                if (photosCount > 0) {
                    alert(`‚úì Email envoy√© au client avec PDF et ${photosCount} photo(s) en pi√®ces jointes !`);
                } else {
                    alert("‚úì Email envoy√© au client avec PDF en pi√®ce jointe !");
                }
                return true;
                
            } catch (error) {
                console.error("Erreur envoi email SMTP OVH:", error);
                console.error("D√©tails de l'erreur:", {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                let errorMessage = "‚ùå Erreur lors de l'envoi de l'email.\n\n";
                
                // Gestion sp√©cifique du timeout
                if (error.name === 'AbortError' || error.message.includes('timeout')) {
                    errorMessage += "‚ö†Ô∏è TIMEOUT:\n\n";
                    errorMessage += "La requ√™te a pris trop de temps (probablement √† cause de la taille des photos).\n";
                    errorMessage += "Sur mobile, essayez avec moins de photos ou des photos plus petites.\n\n";
                    errorMessage += "Solution: R√©duisez le nombre de photos ou leur taille.";
                } else if (error.message.includes('SMTP_API_URL')) {
                    errorMessage += "‚ö†Ô∏è CONFIGURATION REQUISE:\n\n";
                    errorMessage += "1. D√©ployez la fonction serverless sur Vercel\n";
                    errorMessage += "2. Configurez OVH_SMTP_PASSWORD dans Vercel\n";
                    errorMessage += "3. Mettez √† jour SMTP_API_URL dans index.html\n";
                    errorMessage += "4. Voir INSTRUCTIONS_SMTP_OVH.md pour plus de d√©tails";
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage += "‚ö†Ô∏è PROBL√àME DE CONNEXION:\n\n";
                    errorMessage += "Impossible de contacter le serveur d'envoi d'email.\n";
                    errorMessage += "V√©rifiez votre connexion internet et que l'API est accessible.\n\n";
                    errorMessage += "URL API: " + SMTP_API_URL + "\n\n";
                    errorMessage += "D√©tails: " + (error.message || error);
                } else if (error.message.includes('CORS')) {
                    errorMessage += "‚ö†Ô∏è PROBL√àME CORS:\n\n";
                    errorMessage += "L'API bloque les requ√™tes depuis ce domaine.\n";
                    errorMessage += "V√©rifiez la configuration CORS sur Vercel.\n\n";
                    errorMessage += "D√©tails: " + (error.message || error);
                } else {
                    errorMessage += "D√©tails: " + (error.message || error);
                    errorMessage += "\n\nV√©rifiez la console (F12) pour plus d'informations.";
                }
                
                alert(errorMessage);
                throw error;
            }
        }
        
        // Fonction pour envoyer l'email au client via EmailJS (ancienne m√©thode, gard√©e pour compatibilit√©)
        async function envoyerEmailClient(bon) {
            try {
                const emailDest = bon.email;
                const serviceID = EMAILJS_CONFIG.serviceID;
                const templateID = EMAILJS_CONFIG.templateID;
                
                console.log("=== ENVOI EMAIL CLIENT ===");
                console.log("Email destination:", emailDest);
                console.log("Service ID utilis√©:", serviceID);
                console.log("Template ID utilis√©:", templateID);
                console.log("Public Key:", EMAILJS_CONFIG.publicKey);
                console.log('Donn√©es du bon:', bon);
                
                // V√©rification pr√©alable des IDs
                if (!serviceID) {
                    console.warn("‚ö†Ô∏è ATTENTION: Service ID non configur√©. V√©rifiez votre configuration!");
                }
                if (!templateID) {
                    console.warn("‚ö†Ô∏è ATTENTION: Template ID non configur√©. V√©rifiez votre configuration!");
                }
                
                // Ajouter le lien PDF dans le message si disponible
                let messageComplet = bon.message || '';
                if (bon.pdf_url && bon.pdf_url.trim() !== '') {
                    messageComplet += '\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                    messageComplet += 'üìÑ PDF DU BON D\'INTERVENTION\n';
                    messageComplet += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                    messageComplet += 'T√©l√©chargez le PDF complet :\n';
                    messageComplet += bon.pdf_url + '\n';
                    messageComplet += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                    console.log('Lien PDF ajout√© au message:', bon.pdf_url);
                } else {
                    console.warn('‚ö†Ô∏è Pas de lien PDF disponible pour l\'email');
                }
                
                const result = await emailjs.send(serviceID, templateID, {
                    email: emailDest,
                    subject: bon.subject || `Bon d'intervention ${bon.numero}`,
                    numero: bon.numero || '',
                    date: bon.date || '',
                    client: bon.client || '',
                    adresse: bon.adresse || '',
                    telephone: bon.telephone || '',
                    technicien: bon.technicien || '',
                    description: bon.description || '',
                    statut: 'En attente',
                    heure_arrivee: bon.heure_arrivee || '',
                    heure_depart: bon.heure_depart || '',
                    produits: bon.produits || 'Aucun',
                    main_oeuvre: bon.mainOeuvre || '',
                    deplacement: bon.deplacement || '',
                    photos: bon.photos || 'Aucune photo',
                    pdf_url: bon.pdf_url || '',
                    message: messageComplet
                });
                
                console.log('Email envoy√© avec succ√®s:', result);
                alert("‚úì Email envoy√© au client avec succ√®s !");
                return true;
            } catch (error) {
                console.error("Erreur envoi email EmailJS:", error);
                console.error("D√©tails de l'erreur:", {
                    status: error.status,
                    text: error.text,
                    message: error.message
                });
                
                let errorMessage = "‚ùå Erreur lors de l'envoi de l'email.\n\n";
                if (error.text && (error.text.includes("service ID not found") || error.text.includes("Service ID not found"))) {
                    errorMessage += "‚ö†Ô∏è LE SERVICE ID EMAILJS N'EST PAS TROUV√â.\n\n";
                    errorMessage += "üìã CONFIGURATION ACTUELLE:\n";
                    errorMessage += `   Service ID: ${EMAILJS_CONFIG.serviceID}\n`;
                    errorMessage += `   Template ID: ${EMAILJS_CONFIG.templateID}\n`;
                    errorMessage += `   Public Key: ${EMAILJS_CONFIG.publicKey}\n\n`;
                    errorMessage += "üîß POUR CORRIGER:\n";
                    errorMessage += "1. Allez sur: https://dashboard.emailjs.com/admin\n";
                    errorMessage += "2. Dans 'Email Services', copiez votre Service ID r√©el\n";
                    errorMessage += "3. Dans 'Email Templates', copiez votre Template ID r√©el\n";
                    errorMessage += "4. Modifiez la section EMAILJS_CONFIG dans index.html (ligne ~507)\n";
                    errorMessage += "5. Remplacez serviceID et templateID par vos IDs r√©els\n\n";
                    errorMessage += "üí° Les IDs doivent √™tre au format:\n";
                    errorMessage += "   - Service: service_xxxxxxx\n";
                    errorMessage += "   - Template: template_xxxxxxx";
                } else if (error.text && error.text.includes("template")) {
                    errorMessage += "‚ö†Ô∏è ERREUR TEMPLATE ID.\n\n";
                    errorMessage += `Template ID utilis√©: ${EMAILJS_CONFIG.templateID}\n\n`;
                    errorMessage += "V√©rifiez votre Template ID dans le dashboard EmailJS.";
                } else {
                    errorMessage += "D√©tails de l'erreur:\n";
                    errorMessage += error.text || error.message || error;
                }
                
                alert(errorMessage);
                return false;
            }
        }

        // --- Enregistrement du bon c√¥t√© technicien (Firestore) ---
        async function saveBonTech() {
            try {
                // 1. R√©cup√©rer et incr√©menter le compteur
                const compteurRef = db.collection('compteurs').doc('bons');
                const annee = new Date().getFullYear();
                let numero;
                
                await db.runTransaction(async (transaction) => {
                    const compteurDoc = await transaction.get(compteurRef);
                    
                    if (compteurDoc.exists && compteurDoc.data().annee === annee) {
                        // M√™me ann√©e : incr√©menter le compteur
                        numero = compteurDoc.data().dernierNumero + 1;
                    } else {
                        // Nouvelle ann√©e ou premier bon : commencer √† 1
                        numero = 1;
                    }
                    
                    // Mettre √† jour le compteur
                    transaction.set(compteurRef, { 
                        annee: annee, 
                        dernierNumero: numero 
                    });
                });
                
                // 2. Cr√©er le num√©ro d√©finitif au format AAAANNNN (ex: 20250001)
                const numeroDefinitif = annee.toString() + String(numero).padStart(4, '0');
                
                // 3. Mettre √† jour l'affichage du num√©ro
                document.getElementById('bonNumber').textContent = numeroDefinitif;
                
                // 4. Enregistrer le bon avec ce num√©ro
                const bon = {
                    numero: numeroDefinitif,
                    date: document.getElementById('interventionDate').value || new Date().toISOString().slice(0,10),
                    client: document.getElementById('clientName').value || '',
                    phone: (document.getElementById('clientPhone')?.value || '').trim(),
                    email: document.getElementById('clientEmail').value || '',
                    address: document.getElementById('clientAddress').value || '',
                    technicien: document.getElementById('technicien').value || '',
                    description: document.getElementById('description').value || '',
                    heureArrivee: document.getElementById('heureArrivee').value || '',
                    heureDepart: document.getElementById('heureDepart').value || '',
                    moDuree: document.getElementById('moDuree').value || '0h00',
                    moDemiHeures: document.getElementById('moDemiHeures').value || '0 demi-heures',
                    moTarif: document.getElementById('moTarif').value || '35',
                    deplNombre: document.getElementById('deplNombre').value || '0',
                    deplTarif: '70',
                    subtotalProduits: document.getElementById('subtotalProduits').textContent || '0.00‚Ç¨',
                    subtotalMO: document.getElementById('subtotalMO').textContent || '0.00‚Ç¨',
                    subtotalDepl: document.getElementById('subtotalDepl').textContent || '0.00‚Ç¨',
                    totalHT: document.getElementById('totalHT').textContent || '0.00‚Ç¨',
                    totalTVA: document.getElementById('totalTVA').textContent || '0.00‚Ç¨',
                    totalTTC: document.getElementById('totalTTC').textContent || '0.00‚Ç¨',
                    statut: 'en_attente',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    produits: [],
                    photos: photosBon.map(photo => typeof photo === 'string' ? photo : photo.url), // Sauvegarder seulement les URLs
                    signatures: {
                        technicien: (function () { const c = document.getElementById('signatureTech'); try { return c && c.toDataURL ? c.toDataURL() : null; } catch(e){ return null; } })(),
                        client: (function () { const c = document.getElementById('signatureClient'); try { return c && c.toDataURL ? c.toDataURL() : null; } catch(e){ return null; } })()
                    }
                };

                // Enregistrer les produits (index + nom + quantit√©)
                document.querySelectorAll('.product-row').forEach(row => {
                    const index = row.dataset.index;
                    const qtyInput = row.querySelector('.product-qty input');
                    const qty = parseFloat(qtyInput.value) || 0;
                    if (qty > 0) {
                        const name = row.querySelector('.product-name')?.textContent || '';
                        const ref = row.querySelector('.product-ref')?.textContent || '';
                        const price = parseFloat(qtyInput.dataset.price || '0');
                        bon.produits.push({
                            index,
                            nom: name,
                            reference: ref,
                            prixUnitaire: price,
                            quantite: qty
                        });
                    }
                });

                // Le lien de paiement sera g√©n√©r√© uniquement dans le PDF lors de l'envoi
                // Pas besoin de l'enregistrer dans Firebase au moment de l'enregistrement
                
                await db.collection('bons').add(bon);
                
                // Mettre √† jour le badge de notifications
                await mettreAJourBadgeNotifications();
                
                // Envoyer l'email au client automatiquement apr√®s l'enregistrement
                const clientEmail = (document.getElementById('clientEmail').value || '').trim();
                if (clientEmail) {
                    try {
                        await envoyerClient();
                    } catch (emailError) {
                        console.error('Erreur lors de l\'envoi de l\'email au client:', emailError);
                        // Ne pas bloquer si l'email √©choue, le bon est d√©j√† enregistr√©
                    }
                }
                
                const msg = document.getElementById('saveMessage');
                if (msg) {
                    if (clientEmail) {
                        msg.textContent = "Bon enregistr√© et email envoy√© au client.";
                    } else {
                        msg.textContent = "Bon enregistr√© (email non envoy√© - adresse manquante).";
                    }
                    msg.classList.add('show');
                    setTimeout(() => { msg.classList.remove('show'); }, 4000);
                } else {
                    if (clientEmail) {
                        alert("Bon enregistr√© et email envoy√© au client.");
                    } else {
                        alert("Bon enregistr√© (email non envoy√© - adresse manquante).");
                    }
                }
            } catch (e) {
                console.error('Erreur Firestore saveBonTech', e);
                alert("Erreur lors de l'enregistrement du bon (Firestore) : " + (e.message || e));
            }
        }

        // --- Gestion des photos c√¥t√© technicien ---
        
        // Fonction pour compresser une image (r√©duit la taille pour l'envoi mobile)
        function compressImage(file, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Redimensionner si n√©cessaire
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convertir en base64 avec compression
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedBase64);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function ouvrirPhotoPicker() {
            if (photosBon.length >= 5) {
                alert("Maximum 5 photos par bon.");
                return;
            }
            document.getElementById('photoInput').click();
        }

        async function handlePhotoSelect(event) {
            const input = event.target;
            const files = Array.from(input.files || []);
            if (!files.length) return;

            const restant = 5 - photosBon.length;
            const toUpload = files.slice(0, restant);
            const bonIdSafe = (document.getElementById('bonNumber').textContent || 'BON')
                .replace(/[^a-zA-Z0-9-_]/g, '_');

            for (const file of toUpload) {
                // D√©tecter si on est sur mobile pour ajuster la compression
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                const maxWidth = isMobile ? 1000 : 1200; // Plus petit sur mobile
                const quality = isMobile ? 0.7 : 0.8; // Compression plus agressive sur mobile
                
                // Compresser l'image pour r√©duire la taille (important pour mobile)
                console.log('Compression de l\'image:', file.name, 'Taille originale:', (file.size / 1024 / 1024).toFixed(2), 'MB', isMobile ? '(Mobile)' : '(PC)');
                const base64 = await compressImage(file, maxWidth, quality);
                const compressedSize = (base64.length * 3 / 4 / 1024 / 1024).toFixed(2);
                console.log('Taille compress√©e:', compressedSize, 'MB');
                
                // Afficher imm√©diatement une vignette locale pour le technicien
                const localUrl = URL.createObjectURL(file);
                const tempIndex = photosBon.length;
                
                // Stocker l'objet avec URL locale temporaire et base64 compress√©
                photosBon.push({
                    url: localUrl,
                    base64: base64
                });
                renderPhotosPreview();

                try {
                    console.log('=== D√âBUT UPLOAD PHOTO ===');
                    console.log('Fichier:', file.name, 'Taille:', file.size, 'Type:', file.type);
                    
                    const fileName = Date.now() + '-' + (file.name || 'photo').replace(/\s+/g, '_');
                    const filePath = 'bons/' + bonIdSafe + '/' + fileName;
                    console.log('Chemin de stockage:', filePath);
                    
                    const ref = storage.ref(filePath);
                    
                    // Upload avec m√©tadonn√©es pour permettre l'acc√®s public
                    const metadata = {
                        contentType: file.type || 'image/jpeg',
                        cacheControl: 'public, max-age=31536000',
                    };
                    
                    console.log('D√©but upload vers Firebase Storage...');
                    const snap = await ref.put(file, metadata);
                    console.log('Upload r√©ussi, snapshot:', snap);
                    
                    // Obtenir l'URL de t√©l√©chargement (avec token d'acc√®s)
                    const url = await snap.ref.getDownloadURL();
                    console.log('Photo upload√©e, URL:', url);
                    console.log('URL commence par http?', url.startsWith('http'));
                    console.log('URL compl√®te:', url);
                    
                    // V√©rifier que l'URL est valide
                    if (!url || !url.startsWith('http')) {
                        throw new Error('URL invalide g√©n√©r√©e: ' + url);
                    }
                    
                    // Remplacer l'URL locale par l'URL Firebase Storage, mais garder le base64
                    photosBon[tempIndex] = {
                        url: url,
                        base64: base64  // Garder le base64 pour le PDF
                    };
                    console.log('URL et base64 ajout√©s au tableau photosBon √† l\'index', tempIndex);
                    console.log('Tableau photosBon maintenant:', photosBon.map(p => ({url: p.url, hasBase64: !!p.base64})));
                    
                    URL.revokeObjectURL(localUrl);
                    renderPhotosPreview();
                    console.log('=== FIN UPLOAD PHOTO (SUCC√àS) ===');
                } catch (e) {
                    console.error('=== ERREUR UPLOAD PHOTO ===');
                    console.error('Erreur compl√®te:', e);
                    console.error('Message:', e.message);
                    console.error('Code:', e.code);
                    alert("Erreur lors du t√©l√©versement d'une photo: " + (e.message || e));
                    // Retirer la vignette temporaire
                    photosBon.splice(tempIndex, 1);
                    URL.revokeObjectURL(localUrl);
                    renderPhotosPreview();
                }
            }

            // reset input pour pouvoir re-s√©lectionner les m√™mes fichiers si besoin
            input.value = '';
        }

        function renderPhotosPreview() {
            const container = document.getElementById('photosPreview');
            if (!container) return;
            if (!photosBon.length) {
                container.innerHTML = "<p style=\"color:var(--text-light);\">Aucune photo ajout√©e pour le moment.</p>";
                return;
            }
            container.innerHTML = photosBon
                .map((photo, idx) => {
                    // G√©rer les deux formats : ancien (string) et nouveau (objet {url, base64})
                    const url = typeof photo === 'string' ? photo : photo.url;
                    return `<div class="photo-thumb" data-index="${idx}">
                        <img src="${url}" alt="Photo" onclick="openPhotoLightbox('${url.replace(/'/g, "\\'")}')" />
                        <button type="button" class="photo-remove" onclick="removePhoto(${idx}); event.stopPropagation();">√ó</button>
                    </div>`;
                })
                .join("");
        }

        function openPhotoLightbox(url) {
            const overlay = document.getElementById('photoLightbox');
            const img = document.getElementById('photoLightboxImg');
            if (!overlay || !img) return;
            img.src = url;
            overlay.classList.add('show');
        }

        function closePhotoLightbox() {
            const overlay = document.getElementById('photoLightbox');
            if (!overlay) return;
            overlay.classList.remove('show');
        }

        // ============================================
        // GESTION DE LA BASE DE DONN√âES CLIENTS
        // ============================================

        let tousLesClients = []; // Cache des clients

        // Rechercher un client dans la liste d√©roulante
        async function rechercherClient(searchTerm) {
            const resultsDiv = document.getElementById('clientSearchResults');
            if (!resultsDiv) return;
            
            if (!searchTerm || searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            try {
                // Charger les clients depuis Firestore si n√©cessaire
                if (tousLesClients.length === 0) {
                    await chargerTousLesClients();
                }

                // Filtrer les clients
                const term = searchTerm.toLowerCase();
                const filtered = tousLesClients.filter(client => 
                    client.nom.toLowerCase().includes(term) ||
                    (client.email && client.email.toLowerCase().includes(term))
                ).slice(0, 5); // Limiter √† 5 r√©sultats

                if (filtered.length === 0) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                // Afficher les r√©sultats
                resultsDiv.innerHTML = filtered.map(client => `
                    <div onclick="selectionnerClient('${client.id}')" style="padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;" 
                         onmouseover="this.style.background='#f0f7ff'" onmouseout="this.style.background='white'">
                        <div style="font-weight: 600;">${client.nom}</div>
                        ${client.email ? `<div style="font-size: 0.85rem; color: var(--text-light);">${client.email}</div>` : ''}
                    </div>
                `).join('');
                resultsDiv.style.display = 'block';
            } catch (error) {
                console.error('Erreur recherche client:', error);
            }
        }

        // Charger tous les clients depuis Firestore
        async function chargerTousLesClients() {
            try {
                // Charger tous les clients (sans orderBy pour √©viter les probl√®mes d'index)
                const snapshot = await db.collection('clients').get();
                tousLesClients = [];
                snapshot.forEach(doc => {
                    tousLesClients.push({ id: doc.id, ...doc.data() });
                });
                // Trier localement par nom
                tousLesClients.sort((a, b) => {
                    const nomA = (a.nom || '').toLowerCase();
                    const nomB = (b.nom || '').toLowerCase();
                    return nomA.localeCompare(nomB);
                });
                return tousLesClients;
            } catch (error) {
                console.error('Erreur chargement clients:', error);
                return [];
            }
        }

        // S√©lectionner un client et remplir le formulaire
        async function selectionnerClient(clientId) {
            try {
                let client = tousLesClients.find(c => c.id === clientId);
                if (!client) {
                    const doc = await db.collection('clients').doc(clientId).get();
                    if (!doc.exists) {
                        alert('Client introuvable');
                        return;
                    }
                    client = { id: doc.id, ...doc.data() };
                }

                // Remplir le formulaire
                document.getElementById('clientName').value = client.nom || '';
                const phoneField = document.getElementById('clientPhone');
                if (phoneField) phoneField.value = client.telephone || '';
                document.getElementById('clientEmail').value = client.email || '';
                document.getElementById('clientAddress').value = client.adresse || '';

                // Masquer les r√©sultats de recherche
                const resultsDiv = document.getElementById('clientSearchResults');
                if (resultsDiv) resultsDiv.style.display = 'none';
                const searchInput = document.getElementById('clientSearch');
                if (searchInput) searchInput.value = '';

                console.log('Client s√©lectionn√©:', client.nom);
            } catch (error) {
                console.error('Erreur s√©lection client:', error);
                alert('Erreur lors de la s√©lection du client');
            }
        }

        // Enregistrer l'adresse (et cr√©er/mettre √† jour le client)
        async function enregistrerAdresseClient() {
            const nom = (document.getElementById('clientName').value || '').trim();
            const email = (document.getElementById('clientEmail').value || '').trim();
            const telephone = (document.getElementById('clientPhone')?.value || '').trim();
            const adresse = (document.getElementById('clientAddress').value || '').trim();

            if (!nom) {
                return;
            }

            if (!adresse) {
                return;
            }

            try {
                // Charger les clients si n√©cessaire
                if (tousLesClients.length === 0) {
                    await chargerTousLesClients();
                }

                // Chercher si un client existe d√©j√† (d'abord dans le cache local)
                let clientExistant = null;
                let clientId = null;

                // Chercher par email si disponible
                if (email) {
                    clientExistant = tousLesClients.find(c => 
                        c.email && c.email.toLowerCase() === email.toLowerCase()
                    );
                    if (clientExistant) {
                        clientId = clientExistant.id;
                    }
                }

                // Si pas trouv√© par email, chercher par nom exact
                if (!clientExistant) {
                    clientExistant = tousLesClients.find(c => 
                        c.nom && c.nom.toLowerCase() === nom.toLowerCase()
                    );
                    if (clientExistant) {
                        clientId = clientExistant.id;
                    }
                }

                // Pr√©parer les donn√©es √† sauvegarder
                const donneesClient = {
                    nom: nom,
                    email: email || clientExistant?.email || '', // Garder l'ancien email si le champ est vide
                    telephone: telephone || '', // Toujours utiliser la valeur du champ (vide si non renseign√©)
                    adresse: adresse,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (clientExistant && clientId) {
                    // Mettre √† jour le client existant
                    await db.collection('clients').doc(clientId).update(donneesClient);
                    console.log('‚úÖ Client mis √† jour:', nom);
                    alert(`‚úÖ Adresse enregistr√©e pour ${nom} !\n\nLe client a √©t√© mis √† jour dans la base de donn√©es.`);
                } else {
                    // Cr√©er un nouveau client
                    // G√©n√©rer un ID unique valide pour Firestore
                    // Firestore n'accepte que : lettres, chiffres, tirets, underscores
                    let nouveauClientId;
                    if (email) {
                        // Nettoyer l'email pour en faire un ID valide (remplacer @ et . par _)
                        nouveauClientId = email.replace(/[^a-zA-Z0-9_-]/g, '_').substring(0, 150);
                    } else {
                        // Utiliser le nom nettoy√© + timestamp
                        const nomNettoye = nom.replace(/[^a-zA-Z0-9_-]/g, '_').substring(0, 50);
                        nouveauClientId = `${nomNettoye}_${Date.now()}`;
                    }
                    
                    // S'assurer que l'ID n'est pas vide et respecte les r√®gles Firestore
                    if (!nouveauClientId || nouveauClientId.length === 0) {
                        nouveauClientId = `CLIENT_${Date.now()}`;
                    }
                    
                    donneesClient.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    await db.collection('clients').doc(nouveauClientId).set(donneesClient);
                    console.log('‚úÖ Nouveau client cr√©√©:', nom);
                    alert(`‚úÖ Nouveau client cr√©√© : ${nom} !\n\nL'adresse a √©t√© enregistr√©e dans la base de donn√©es.`);
                }

                // Recharger la liste des clients pour mettre √† jour le cache
                await chargerTousLesClients();

            } catch (error) {
                console.error('Erreur enregistrement adresse:', error);
                alert('‚ùå Erreur lors de l\'enregistrement de l\'adresse.\n\nD√©tails: ' + error.message);
            }
        }

        async function removePhoto(index) {
            if (index < 0 || index >= photosBon.length) return;
            // Optionnel : suppression dans Storage √† partir de l'URL
            try {
                const photo = photosBon[index];
                const url = typeof photo === 'string' ? photo : photo.url;
                if (url && url.startsWith('http') && storage && storage.refFromURL) {
                    await storage.refFromURL(url).delete();
                } else if (url && url.startsWith('blob:')) {
                    URL.revokeObjectURL(url);
                }
            } catch (e) {
                console.warn('Erreur lors de la suppression du fichier Storage (ignor√©e)', e);
            }
            photosBon.splice(index, 1);
            renderPhotosPreview();
        }
    </script>
</body>
</html>